<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#2563eb" />
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1420" />
<meta name="apple-mobile-web-app-title" content="Nassau Hi/Low by Bunch Bets (V3.0)" />

<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon-16.png">
<link rel="icon" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/BunchBets180.png">
<link rel="mask-icon" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/safari-pinned-tab.svg" color="#2563eb">
<link rel="manifest" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/manifest.webmanifest" crossorigin="anonymous">
<meta name="msapplication-TileColor" content="#0f1420">
<meta name="msapplication-config" content="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/browserconfig.xml" />

<link rel="icon" href="favicon.ico" />
<title>Bunch Bets (Build 3.0)</title>
<style>
  :root { --bg:#0b0e13; --card:#0f1420; --txt:#ecf0f6; --muted:#a3a9b6; --border:#1e2633; --acc:#3b82f6; color-scheme: light dark; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--txt); background:var(--bg); }
  header{ background:var(--card); border-bottom:1px solid var(--border); padding:10px 12px; position:sticky; top:0; z-index:10; }
  h1{ font-size:18px; margin:0; }
  main{ padding:12px; }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:none; }
  .btn{ background:var(--card); border:1px solid var(--border); border-radius:999px; padding:8px 12px; cursor:pointer; color:var(--txt); }
  .btn.primary{ background:var(--acc); color:#fff; border-color:var(--acc); }
  .btn.danger {
  background: #dc2626;   /* Tailwind red-600 */
  border-color: #dc2626;
  color: #fff;
}
.btn.danger:hover {
  background: #b91c1c;   /* darker red */
  border-color: #b91c1c;
}
.btn.share {
  background: #16a34a;        /* green-600 */
  border-color: #16a34a;
  color: #fff;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(22,163,74,0.35);
}

.btn.share:hover {
  background: #15803d;        /* green-700 */
  border-color: #15803d;
}

.btn.share:active {
  background: #166534;        /* green-800 */
  border-color: #166534;
}



  .btn.small{ padding:6px 10px; font-size:14px; }
  .pill{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; display:inline-block; background:rgba(255,255,255,0.02); }
  .grid{ display:grid; gap:8px; }
  .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .muted{ color:var(--muted); }
  input[type="text"],input[type="tel"],select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%; font-size:16px; min-height:44px; color:var(--txt); background:transparent; }
  table{ border-collapse:collapse; width:100%; font-size:14px; }
  th,td{ border:1px solid var(--border); padding:6px; text-align:center; vertical-align:top; }
  th.sticky, td.sticky{ position:sticky; left:0; background:var(--card); z-index:2; text-align:left; }
  .tabs{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 10px; }
  .tabs .btn.active{ background:var(--acc); color:#fff; border-color:var(--acc); }
  .scroll{ overflow:auto; }
  .note{ font-size:12px; color:var(--muted); }
  .error{ position:fixed; bottom:8px; left:8px; right:8px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; border-radius:12px; padding:8px 12px; font-size:12px; display:none; z-index:9999; white-space:pre-wrap; }

  .theme-g1 .card{ outline: 1px solid rgba(22,163,74,.45); background: linear-gradient(0deg, rgba(22,163,74,.08), rgba(22,163,74,.08)) var(--card); }
  .theme-g2 .card{ outline: 1px solid rgba(220,38,38,.45); background: linear-gradient(0deg, rgba(220,38,38,.08), rgba(220,38,38,.08)) var(--card); }
  .theme-g3 .card{ outline: 1px solid rgba(217,119,6,.45);  background: linear-gradient(0deg, rgba(217,119,6,.08),  rgba(217,119,6,.08))  var(--card); }

  .shape-g1 .card{ outline: 1px solid rgba(22,163,74,.45); background: linear-gradient(0deg, rgba(22,163,74,.08), rgba(22,163,74,.08)) var(--card); }
  .shape-g2 .card{ outline: 1px solid rgba(220,38,38,.45); background: linear-gradient(0deg, rgba(220,38,38,.08), rgba(220,38,38,.08)) var(--card); }
  .shape-g3 .card{ outline: 1px solid rgba(217,119,6,.45);  background: linear-gradient(0deg, rgba(217,119,6,.08),  rgba(217,119,6,.08))  var(--card); }

  .cellWrap{ position:relative; }
  .cellWrap input{ width:54px; text-align:center; padding-right:14px; }
  .cellWrap .dots{ position:absolute; right:2px; top:4px; display:flex; flex-direction:column; align-items:center; gap:2px; font-size:12px; line-height:1; pointer-events:none; user-select:none; }
  .cellWrap .dot{ width:6px; height:6px; border-radius:50%; }
  .cellWrap .dot.g1{ background-color:#16a34a; }
  .cellWrap .dot.g2{ background-color:#dc2626; }
  .cellWrap .dot.g3{ background-color:#d97706; }

  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --card:#fff; --txt:#111; --muted:#666; --border:#e5e7eb; --acc:#2563eb; }
    .theme-g1 .card, .shape-g1 .card{ outline: 1px solid rgba(22,163,74,.35); background: linear-gradient(0deg, rgba(22,163,74,.10), rgba(22,163,74,.10)) var(--card); }
    .theme-g2 .card, .shape-g2 .card{ outline: 1px solid rgba(220,38,38,.35); background: linear-gradient(0deg, rgba(220,38,38,.10), rgba(220,38,38,.10)) var(--card); }
    .theme-g3 .card, .shape-g3 .card{ outline: 1px solid rgba(217,119,6,.35);  background: linear-gradient(0deg, rgba(217,119,6,.10),  rgba(217,119,6,.10))  var(--card); }
  }

  /* Junk input + tiny badge (no full overlay) */
.junkWrap{ position:relative; display:inline-block; }
.junkBox{
  width: 32px;
  text-align:center;
  font-variant-numeric: tabular-nums;
  font-size: 17px !important;
  line-height: normal !important;
  height: auto !important;
  padding: 2px;
  -webkit-text-size-adjust: 100% !important;
  text-rendering: optimizeLegibility;
}
.junkVal{
  position:absolute;
  top: 2px;
  right: 4px;
  font-size: 10px;
  line-height: 1;
  opacity: 0.9;
  pointer-events:none;
  user-select:none;
}
/* Ensure input text always paints above the badge */
.junkWrap .junkBox{ position: relative; z-index: 2; }
.junkWrap .junkVal{ z-index: 1; }

  
/* Show badge only when input is empty */
.junkWrap .junkBox:not(:placeholder-shown) + .junkVal { display:none; }
.junkWrap:focus-within .junkVal { display:none; }

  .junkWrap{ position: relative; }
  .junkBox{ width: 32px; text-align: center; font-size: 12px; padding: 2px; }
  .junkVal{ position: absolute; top: 0; right: 4px; font-size: 10px; pointer-events: none; }
  body.light .junkVal { color: #000; }
  body.dark .junkVal { color: #fff; }
  td[id^="junkF_"], td[id^="junkB_"] { text-align: center; vertical-align: middle; font-weight: 600; }
  .junkValueBar{ display:flex; align-items:center; gap:12px; flex-wrap:nowrap; }
  .junkBox{ font-size: 17px !important; line-height: normal !important; height: auto !important; -webkit-text-size-adjust: 100% !important; text-rendering: optimizeLegibility; }
  .junkVal{ font-size: 17px !important; line-height: 1 !important; }
  @media (prefers-color-scheme: light){ .junkBox, .junkVal { color:#0f172a !important; } }
  @supports (-webkit-touch-callout: none){ .junkBox, .junkVal { font-size: 18px !important; } }

  :root{ --input-bg: rgba(255,255,255,0.06); --input-border-strong: rgba(255,255,255,0.22); }
  @media (prefers-color-scheme: light){ :root{ --input-bg: #f3f4f6; --input-border-strong: #d1d5db; } }
  input[type="text"], input[type="tel"], input[type="number"], select, textarea{ background-color: var(--input-bg); border-color: var(--input-border-strong); color: var(--txt); }
  .junkBox{ background-color: var(--input-bg) !important; border-color: var(--input-border-strong) !important; color: var(--txt) !important; -webkit-text-fill-color: var(--txt) !important; }
  input:focus, select:focus, textarea:focus{ outline: 2px solid var(--acc); outline-offset: 1px; }
  ::placeholder{ color: var(--muted); opacity: 0.9; }
  /* Extra themes beyond 3 */
  .theme-g4 .card{ outline:1px solid rgba(99,102,241,.45); background: linear-gradient(0deg, rgba(99,102,241,.08), rgba(99,102,241,.08)) var(--card); }
  .theme-g5 .card{ outline:1px solid rgba(20,184,166,.45); background: linear-gradient(0deg, rgba(20,184,166,.08), rgba(20,184,166,.08)) var(--card); }
  .theme-g6 .card{ outline:1px solid rgba(219,39,119,.45); background: linear-gradient(0deg, rgba(219,39,119,.08), rgba(219,39,119,.08)) var(--card); }
  .shape-g4 .card{ outline:1px solid rgba(99,102,241,.45); background: linear-gradient(0deg, rgba(99,102,241,.08), rgba(99,102,241,.08)) var(--card); }
  .shape-g5 .card{ outline:1px solid rgba(20,184,166,.45); background: linear-gradient(0deg, rgba(20,184,166,.08), rgba(20,184,166,.08)) var(--card); }
  .shape-g6 .card{ outline:1px solid rgba(219,39,119,.45); background: linear-gradient(0deg, rgba(219,39,119,.08), rgba(219,39,119,.08)) var(--card); }

  /* Light mode variants for extra themes */
  @media (prefers-color-scheme: light){
    .theme-g4 .card, .shape-g4 .card{ outline:1px solid rgba(99,102,241,.35); background: linear-gradient(0deg, rgba(99,102,241,.10), rgba(99,102,241,.10)) var(--card); }
    .theme-g5 .card, .shape-g5 .card{ outline:1px solid rgba(20,184,166,.35); background: linear-gradient(0deg, rgba(20,184,166,.10), rgba(20,184,166,.10)) var(--card); }
    .theme-g6 .card, .shape-g6 .card{ outline:1px solid rgba(219,39,119,.35); background: linear-gradient(0deg, rgba(219,39,119,.10), rgba(219,39,119,.10)) var(--card); }
  }

  /* Extra dot colors for additional games */
  .cellWrap .dot.g4{ background-color:#6366f1; }
  .cellWrap .dot.g5{ background-color:#14b8a6; }
  .cellWrap .dot.g6{ background-color:#db2777; }

label.radio-nowrap {
  white-space: nowrap;
  padding-right: 6px;
}
/* keep short headings/labels on one line */
.nowrap { white-space: nowrap; }

/* radios: a hair of padding so text doesn't crowd */
label.radio-nowrap { white-space: nowrap; padding-right: 8px; }

/* on very small phones, stack the row instead of ugly wraps */
@media (max-width: 420px){
  .game-options { grid-template-columns: 1fr !important; gap: 12px 16px !important; }
}
/* Force Nassau Scoring | Team Size into 2 columns on normal phones */
.game-options-row{
  display:grid;
  grid-template-columns: minmax(0,1.2fr) minmax(0,0.8fr);
  gap:16px 20px;
  align-items:start;
}

/* Only stack on *very* small screens */
@media (max-width: 360px){
  .game-options-row{
    grid-template-columns: 1fr;
  }
}
/* === Highlights styles === */
.highlights-wrap{display:flex;flex-direction:column;gap:12px;padding:12px}
.hl-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.hl-toolbar .pill{background:var(--card);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.hl-toolbar input[type="number"]{width:88px;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.hl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:8px}
.hl-card{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
.hl-row{display:flex;justify-content:space-between;gap:12px;align-items:center}
.hl-hole{font-weight:700;font-size:14px}
.hl-amt{font-weight:800}
.hl-amt.win{color:#16a34a}
.hl-amt.loss{color:#dc2626}
.hl-desc{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.35}
.hl-badge{font-size:11px;border-radius:6px;border:1px solid var(--border);padding:2px 6px;margin-right:6px}
.hl-badges{margin-top:6px}
.hl-empty{padding:16px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}
/* Hide the overlay number while editing so you don't see two digits */

/* Show overlay only when input is empty */
.junkWrap .junkBox:not(:placeholder-shown) + .junkVal {
  display: none;
}

/* Also hide overlay while editing */
.junkWrap:focus-within .junkVal {
  display: none;
}
/* iOS: show the native digits and kill any overlay on junk inputs */
.ios .junkBox{
  color: var(--txt) !important;
  -webkit-text-fill-color: var(--txt) !important;
  opacity: 1 !important;
  text-shadow: none !important;
  caret-color: var(--txt) !important;
  background-clip: padding-box !important;
  -webkit-appearance: none;
  transform: translateZ(0); /* WebKit repaint nudge */
}
.ios .junkWrap .junkVal{ display: none !important; }


/* Optional: ensure background contrast for the junk cells */
.junk input[type="number"],
.junk input[type="text"] {
  background-color: var(--cellBg, rgba(0,0,0,0.04));
}
@media (prefers-color-scheme: dark) {
  .junk input[type="number"],
  .junk input[type="text"] {
    background-color: rgba(255,255,255,0.06);
  }
}

.ios .junk input { transform: translateZ(0); }



</style>
</head>
<body>
<header>
  <div class="row" style="align-items:center; justify-content:space-between;">
    <h1>Bunch Bets (Build 3.0)</h1>
    <div class="row" style="align-items:center;">
    <button class="btn small" id="resetBtn">New Round</button>
    <button class="btn small" id="clearBtn" style="margin-left:6px;">Clear Scores</button>
    <button class="btn small" id="factoryBtn" style="margin-left:6px;">Factory Reset</button>

    </div>
  </div>
</header>
<main>
  <div id="tabs" class="tabs"></div>
  <div id="app"></div>
</main>
<div id="err" class="error"></div>

<script>
(function(){
  'use strict';

  // ===== Utilities =====
  function fmt(n){ if(!isFinite(n)) return "$0.00"; var s=n<0?'-':''; n=Math.abs(n); return s+"$"+n.toFixed(2); }
  function make18(fill){ var a=[]; for(var i=0;i<18;i++) a.push(fill); return a; }
  function uid(){ return Math.random().toString(36).slice(2); }

  var errBox=document.getElementById('err');
  window.addEventListener('error', function(ev){ errBox.style.display='block'; var loc=(ev.filename?(' @ '+ev.filename+':'+ev.lineno+':'+ev.colno):''); errBox.textContent=String(ev.message||ev)+loc; });

  // ===== State & Persistence =====
  var STORAGE_KEY='nassauV26';
  var state={
    tab:'setup',
    debugStatus:false,
    ui: { currentHole: -1 },
    players:[{id:'p1',name:'P1'},{id:'p2',name:'P2'},{id:'p3',name:'P3'},{id:'p4',name:'P4'},{id:'p5',name:'P5'}],
    games:[],
    activeGameId:null,
    course:{ name:'El Macero',
  hcp:[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
  par:[4,5,3,4,5,4,3,4,4,4,4,3,4,4,5,3,4,5] // default for El Macero
}



  };

  var COURSE_PRESETS={
    'El Macero': {
    hcp:[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
    par:[4,5,3,4,5,4,3,4,4,4,4,3,4,4,5,3,4,5]
  },
  'El Macero Temp': {
    hcp:[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6],
    par:[4,5,3,4,5,4,3,4,4,4,5,3,4,5,4,3,4,4]
  }
};


  function cloneForSave(){ return { tab:state.tab, debugStatus:state.debugStatus, players:state.players, games:state.games, activeGameId:state.activeGameId, course:state.course, presets:COURSE_PRESETS }; }
  function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){} }
  function loadState(){
    try{
      var raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false;
      var obj=JSON.parse(raw); if(!obj||!Array.isArray(obj.games)) return false;
      state.tab=obj.tab||state.tab; state.debugStatus=!!obj.debugStatus;
      if(Array.isArray(obj.players)) state.players=obj.players;
      if(Array.isArray(obj.games)) state.games=obj.games;
      state.activeGameId=obj.activeGameId||state.activeGameId;
      if(obj.ui && typeof obj.ui==='object') state.ui = obj.ui;
      if(obj.course&&obj.course.hcp&&obj.course.hcp.length===18){ state.course.hcp=obj.course.hcp; state.course.name=obj.course.name||state.course.name; }
      if(obj.course && Array.isArray(obj.course.par) && obj.course.par.length===18){
  state.course.par=obj.course.par;
}

      if(obj.presets && typeof obj.presets==='object') COURSE_PRESETS=obj.presets;
      return true;
    }catch(_e){ return false; }
  }

  var __loaded=loadState();
  function makeNewGame(cloneFromFirst){
    var g={ id:uid(),
      teamA:['p1','p2'], teamB:['p3','p4'],
      teamSize:2,                   // NEW: 1 or 2
      scoringMode:'hi_low',        // NEW: 'low_net' | 'hi_low'
      stakes:{front:2,back:4,overall:2},
      autoPress:{front:true,back:true,overall:false},
      junkValue:{front:1,back:2},
      junkCounts:{}, strokesCount:{}, gross:{} };
    for(var i=0;i<state.players.length;i++){
      var pid=state.players[i].id;
      g.junkCounts[pid]=make18(0);
      g.strokesCount[pid]=0;
      var useClone = !!cloneFromFirst && state.games && state.games.length>0;
      var base = useClone ? (state.games[0].gross[pid]||make18(null)) : make18(null);
      g.gross[pid]=base.slice();
    }
    return g;
  }

  if(!__loaded || !state.games || !state.games.length){ state.games=[makeNewGame(false)]; state.activeGameId=state.games[0].id; }

  function sanitizeGame(g){
    if(!g || typeof g!=='object') return makeNewGame(false);
    // NEW defaults
    g.teamSize = (g.teamSize===1||g.teamSize===2)? g.teamSize : 2;
    g.scoringMode = (g.scoringMode==='low_net'||g.scoringMode==='hi_low')? g.scoringMode : 'hi_low';

    g.teamA = Array.isArray(g.teamA)? g.teamA.slice(0,g.teamSize):[];
    g.teamB = Array.isArray(g.teamB)? g.teamB.slice(0,g.teamSize):[];

    g.stakes = g.stakes || {front:2,back:4,overall:2};
    g.stakes.front=isFinite(+g.stakes.front)?+g.stakes.front:2;
    g.stakes.back=isFinite(+g.stakes.back)?+g.stakes.back:4;
    g.stakes.overall=isFinite(+g.stakes.overall)?+g.stakes.overall:2;

    g.autoPress=g.autoPress||{front:true,back:true,overall:false};
    g.autoPress.front=!!g.autoPress.front; g.autoPress.back=!!g.autoPress.back; g.autoPress.overall=!!g.autoPress.overall;

    g.junkValue=g.junkValue||{front:1,back:2};
    g.junkValue.front=isFinite(+g.junkValue.front)?+g.junkValue.front:1;
    g.junkValue.back=isFinite(+g.junkValue.back)?+g.junkValue.back:2;

    g.gross=g.gross||{}; g.junkCounts=g.junkCounts||{}; g.strokesCount=g.strokesCount||{};
    for(var i=0;i<state.players.length;i++){
      var pid=state.players[i].id;
      var ga=Array.isArray(g.gross[pid])? g.gross[pid].slice(0,18):make18(null); while(ga.length<18) ga.push(null);
      for(var k=0;k<18;k++){ var v=ga[k]; ga[k]=(v===''||v==null)?null:(isFinite(+v)?+v:null); }
      g.gross[pid]=ga;
      var ja=Array.isArray(g.junkCounts[pid])? g.junkCounts[pid].slice(0,18):make18(0); while(ja.length<18) ja.push(0);
      for(var j=0;j<18;j++){ var vv=ja[j]; ja[j]=isFinite(+vv)?+vv:0; }
      g.junkCounts[pid]=ja;
      g.strokesCount[pid]=isFinite(+g.strokesCount[pid])?+g.strokesCount[pid]:0;
    }
    g.id=g.id||uid();
    return g;
  }

  function migrateState(){
    if(!state.course || !Array.isArray(state.course.hcp) || state.course.hcp.length!==18){
  state.course={name:'El Macero',
    hcp:[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
    par:[4,5,3,4,5,4,3,4,4,4,4,3,4,4,5,3,4,5]
  };
  if(!state.course.par || state.course.par.length!==18){
    state.course.par = make18(4); // safe default
  }
}

    for(var gi=0; gi<state.games.length; gi++){ state.games[gi]=sanitizeGame(state.games[gi]); }
    var hasActive=false; for(var gx=0; gx<state.games.length; gx++){ if(state.games[gx].id===state.activeGameId){ hasActive=true; break; } }
    if(!hasActive){ state.activeGameId=state.games[0].id; }
  }
  migrateState();

  var __saveTimer=null; function queueSave(){ if(__saveTimer) clearTimeout(__saveTimer); __saveTimer=setTimeout(saveState,200); }

  // ===== DOM helper =====
  function h(tag,attrs,children){
    var el=document.createElement(tag); attrs=attrs||{}; children=(children==null)?[]:(Array.isArray(children)?children:[children]);
    for(var ak in attrs){ if(!attrs.hasOwnProperty(ak)) continue; var v=attrs[ak];
      if(ak==='class') el.className=v;
      else if(ak==='style') el.setAttribute('style',v);
      else if(ak==='value'){ var vv=(v==null?'':String(v)); el.value=vv; try{ el.setAttribute('value', vv);}catch(_e){} }
      else if(ak==='checked') el.checked=!!v;
      else if(ak==='disabled') el.disabled=!!v;
      else if(ak==='selected') el.selected=!!v;
      else if(ak.slice(0,2)==='on' && typeof v==='function'){ el.addEventListener(ak.slice(2).toLowerCase(), v); }
      else el.setAttribute(ak,v);
    }
    for(var i=0;i<children.length;i++){ var ch=children[i]; if(ch==null) continue; if(typeof ch==='string') el.appendChild(document.createTextNode(ch)); else el.appendChild(ch); }
    return el;
  }

  // ===== Helpers =====
  var __locks=0, __rt=null;
  function beginEdit(){ __locks++; }
  function endEdit(){ __locks=Math.max(0,__locks-1); if(!__locks){ if(__rt) clearTimeout(__rt); queueSave(); __rt=setTimeout(render,120); } }
  function getGame(id){ for(var i=0;i<state.games.length;i++){ if(state.games[i].id===id) return state.games[i]; } return state.games[0]; }
  function playerName(id){ for(var i=0;i<state.players.length;i++){ if(state.players[i].id===id) return state.players[i].name; } return id; }
  function gameShortLabel(g){
    function abbr(pid, used){
      var nm=playerName(pid)||''; var hasDigits=/[0-9]/.test(nm);
      if(hasDigits){ var s=nm.toUpperCase(); if(!used[s]){ used[s]=true; return s; } }
      var base=nm.replace(/[^A-Za-z]/g,'').toUpperCase(); if(!base) base=String(pid).toUpperCase();
      for(var len=1; len<=Math.min(3,base.length); len++){ var cand=base.slice(0,len); if(!used[cand]){ used[cand]=true; return cand; } }
      var stem=base.slice(0,2)||base; var n=2; while(used[stem+n]) n++; used[stem+n]=true; return stem+n;
    }
    var used={};
    var a1=g.teamA&&g.teamA[0]?abbr(g.teamA[0],used):'', a2=g.teamA&&g.teamA[1]?abbr(g.teamA[1],used):'';
    var b1=g.teamB&&g.teamB[0]?abbr(g.teamB[0],used):'', b2=g.teamB&&g.teamB[1]?abbr(g.teamB[1],used):'';
    var left=(a1&&a2)?(a1+'/'+a2):(a1||a2||'Team A'); var right=(b1&&b2)?(b1+'/'+b2):(b1||b2||'Team B');
    var mode = g.scoringMode==='low_net' ? 'Best Ball' : 'Hi/Low';
    var vs = left+' vs '+right;
    return mode+': '+vs;
  }
  function gameLongLabel(game){ function nm(pid){return playerName(pid)||'?';} return (game.teamA||[]).map(nm).join(' & ')+' vs '+(game.teamB||[]).map(nm).join(' & '); }

  // ===== Strokes & scoring =====
  function strokesFor(game,pid,hole){
    var n=+game.strokesCount[pid]||0; if(!n) return 0;
    var base=Math.floor(n/18), rem=n%18, rank=+state.course.hcp[hole]||0;
    return base + ((rank>0 && rank<=rem)?1:0);
  }
  function computeNet(gross,s){ if(gross==null||!isFinite(gross)) return null; return gross - (isFinite(s||0)?(s||0):0); }
  function sumGrossRange(arr,start,end){ var t=0, any=false; for(var i=start;i<=end;i++){ var v=arr&&arr[i]; if(v!=null && isFinite(+v)){ t+=+v; any=true; } } return any? t : null; }
function getLastScoredHole0Based(){
  var g0 = state.games && state.games[0];
  if(!g0 || !g0.gross) return -1;
  var last = -1;
  for (var holeI=0; holeI<18; holeI++){
    for (var pi=0; pi<state.players.length; pi++){
      var pid = state.players[pi].id;
      var v = g0.gross[pid] ? g0.gross[pid][holeI] : null;
      if(v!=null && v!==''){ last = holeI; break; }
    }
  }
  return last;
}

  function bestNetForTeam(game, teamIds, hole){
    var G=game.gross, best=Infinity, has=false;
    for(var i=0;i<teamIds.length;i++){
      var pid=teamIds[i]; var g=G[pid]&&G[pid][hole];
      var n=computeNet(g,strokesFor(game,pid,hole));
      if(n==null) continue; if(n<best){ best=n; has=true; }
    }
    return has? best : null;
  }

  // Hole diff (A perspective) respecting scoring mode and team size
  function holeDiff(game,hole){
    var A=game.teamA||[], B=game.teamB||[], G=game.gross||{};
    if(game.scoringMode==='low_net'){
      var aLow=bestNetForTeam(game,A,hole), bLow=bestNetForTeam(game,B,hole);
      if(aLow==null || bLow==null) return null;
      return (aLow<bLow)? 1 : (bLow<aLow)? -1 : 0;
    }
    // Hi/Low path (prefers 2v2). If not 2v2, gracefully degrade to Low Net.
    if(A.length<2 || B.length<2){
      var aL=bestNetForTeam(game,A,hole), bL=bestNetForTeam(game,B,hole);
      if(aL==null || bL==null) return null;
      return (aL<bL)? 1 : (bL<aL)? -1 : 0;
    }
    var gA0=G[A[0]][hole], gA1=G[A[1]][hole], gB0=G[B[0]][hole], gB1=G[B[1]][hole];
    if(gA0==null||gA1==null||gB0==null||gB1==null) return null; // require gross present
    var a0=computeNet(gA0,strokesFor(game,A[0],hole));
    var a1=computeNet(gA1,strokesFor(game,A[1],hole));
    var b0=computeNet(gB0,strokesFor(game,B[0],hole));
    var b1=computeNet(gB1,strokesFor(game,B[1],hole));
    var aLow=Math.min(a0,a1), bLow=Math.min(b0,b1), aHigh=Math.max(a0,a1), bHigh=Math.max(b0,b1);
    var lowW=(aLow<bLow)?'A':(bLow<aLow)?'B':'T';
    var highW=(aHigh<bHigh)?'A':(bHigh<aHigh)?'B':'T';
    var d=0; if(lowW==='A') d++; else if(lowW==='B') d--; if(highW==='A') d++; else if(highW==='B') d--; return d;
  }

  function buildSegmentLines(game,start,end,stake,auto){
    var diffs=[]; for(var i=0;i<18;i++) diffs.push(holeDiff(game,i));
    var lines=[{start:start,end:end,stake:stake,pressesTriggered:0}];
    if(auto){
      for(var hIdx=start; hIdx<=end; hIdx++){
        var pressedThisHole=false;
        for(var li=0; li<lines.length; li++){
          var L=lines[li]; if(L.start>hIdx) continue;
          var cum=0, complete=true; for(var hi=L.start; hi<=hIdx; hi++){ var d=diffs[hi]; if(d==null){ complete=false; break; } cum+=d; }
          if(!complete || hIdx>=end) continue;
          var k=Math.floor(Math.abs(cum)/2);
          if(k>L.pressesTriggered){
            if(!pressedThisHole){
              var nextStart=hIdx+1; if(!lines.some(function(x){return x.start===nextStart;})){
                lines.push({start:nextStart,end:end,stake:stake,pressedBy:(cum<0?'A':'B'),pressesTriggered:0});
                pressedThisHole=true;
              }
            }
            L.pressesTriggered=k;
          }
        }
      }
    }
    var winnerByLine=[], payoutA_base=0, teamPayoutA=0;
    var sizeA=(game.teamA||[]).length||0, sizeB=(game.teamB||[]).length||0;
    for(var j=0;j<lines.length;j++){
      var L2=lines[j], cum2=0, complete2=true;
      for(var hj=L2.start; hj<=L2.end; hj++){ var d2=diffs[hj]; if(d2==null){ complete2=false; break; } cum2+=d2; }
      if(!complete2){ winnerByLine.push('In-Play'); continue; }
      if(cum2>0){ winnerByLine.push('A'); payoutA_base+=L2.stake; teamPayoutA += L2.stake * (sizeB||1); }
      else if(cum2<0){ winnerByLine.push('B'); payoutA_base-=L2.stake; teamPayoutA -= L2.stake * (sizeA||1); }
      else winnerByLine.push('Push');
    }
    return {lines:lines, winnerByLine:winnerByLine, payoutA:payoutA_base, teamPayoutA:teamPayoutA};
  }

  function computeJunk(game){
    var jv=game.junkValue||{front:0,back:0};
    function sumTeam(pids,a,b){ var t=0; for(var i=0;i<pids.length;i++){ var pid=pids[i], arr=game.junkCounts[pid]||[]; for(var hq=a; hq<=b; hq++) t+=(+arr[hq]||0); } return t; }
    var aF=sumTeam(game.teamA,0,8), aB=sumTeam(game.teamA,9,17), bF=sumTeam(game.teamB,0,8), bB=sumTeam(game.teamB,9,17);
    var aVal=aF*(+jv.front||0)+aB*(+jv.back||0), bVal=bF*(+jv.front||0)+bB*(+jv.back||0);
    return {aVal:aVal,bVal:bVal,netA:(aVal-bVal)}; // netA can be negative
  }

  // Per-player stake model: each losing player owes full stake
  function computeGameResult(game){
    var seg={
      front:buildSegmentLines(game,0,8,game.stakes.front,!!game.autoPress.front),
      back:buildSegmentLines(game,9,17,game.stakes.back,!!game.autoPress.back),
      overall:buildSegmentLines(game,0,17,game.stakes.overall,!!game.autoPress.overall)
    };
    var junk=computeJunk(game);
    var sizeA=(game.teamA||[]).length||1, sizeB=(game.teamB||[]).length||1;

    // Segment team nets already account for losers count
    var frontTeam=seg.front.teamPayoutA;
    var backTeam=seg.back.teamPayoutA;
    var overallTeam=seg.overall.teamPayoutA;

    // Junk: multiply by losers count depending on sign
    var junkTeam = 0;
    if(junk.netA>0) junkTeam = junk.netA * (sizeB||1);
    else if(junk.netA<0) junkTeam = junk.netA * (sizeA||1);

    var totalTeamA=frontTeam+backTeam+overallTeam+junkTeam;
    return {segments:seg, junk:junk, teamTotals:{front:frontTeam, back:backTeam, overall:overallTeam, junk:junkTeam, total:totalTeamA}, totalPayoutA:totalTeamA};
  }

  function settleMinimalCash(net){
    var debt=[],cred=[];
    for(var id in net){ var amt=net[id]; if(Math.abs(amt)<0.005) continue; if(amt<0) debt.push({id:id,amt:-amt}); else cred.push({id:id,amt:amt}); }
    debt.sort(function(a,b){return b.amt-a.amt;}); cred.sort(function(a,b){return b.amt-a.amt;});
    var xfers=[],i=0,j=0; while(i<debt.length && j<cred.length){
      var d=debt[i], c=cred[j], pay=Math.min(d.amt,c.amt);
      xfers.push({from:d.id,to:c.id,amount:pay}); d.amt-=pay; c.amt-=pay;
      if(d.amt<=0.005) i++; if(c.amt<=0.005) j++;
    }
    return xfers;
  }

  function fmtTeamPlayer(total, teamSizeA){
    var sz = Math.max(1, teamSizeA||1);
    return fmt(total) + ' / ' + fmt(total / sz);
  }

// === Aggregate Zero-Baseline Highlights (per hole) ===

// Deep clone for counterfactuals
function cloneGame(g){ return JSON.parse(JSON.stringify(g)); }

// Label (optional, just for nice text)
function eventLabelForScore(gross, par){
  if(gross==null || par==null) return null;
  var d = gross - par;
  if(d <= -3) return 'albatross';
  if(d === -2) return 'eagle';
  if(d === -1) return 'birdie';
  if(d ===  1) return 'bogey';
  if(d >=  2) return 'double bogey';
  return null; // par or unknown
}

// Who won the hole (for attribution)
function hlHoleWinners(game, hole){
  var A=game.teamA||[], B=game.teamB||[];
  var mode=game.scoringMode||'hi_low';
  function nets(team){
    var out=[];
    for(var i=0;i<team.length;i++){
      var pid=team[i], g=game.gross[pid] && game.gross[pid][hole];
      if(g==null) continue;
      var net = computeNet(g, strokesFor(game,pid,hole));
      if(net!=null) out.push({pid, net});
    }
    return out;
  }
  var a=nets(A), b=nets(B);
  if(!a.length || !b.length) return {side:null,pids:[]};

  a.sort((x,y)=>x.net-y.net);
  b.sort((x,y)=>x.net-y.net);

  if(mode==='low_net' || A.length<2 || B.length<2){
    if(a[0].net < b[0].net) return {side:'A', pids:[a[0].pid]};
    if(b[0].net < a[0].net) return {side:'B', pids:[b[0].pid]};
    return {side:null,pids:[]};
  }else{
    var pts=0, pids=[];
    if(a[0].net < b[0].net){ pts++; pids.push(a[0].pid); }
    else if(b[0].net < a[0].net){ pts--; pids.push(b[0].pid); }
    var ah=a[a.length-1], bh=b[b.length-1];
    if(ah.net < bh.net){ pts++; if(pids.indexOf(ah.pid)<0) pids.push(ah.pid); }
    else if(bh.net < ah.net){ pts--; if(pids.indexOf(bh.pid)<0) pids.push(bh.pid); }
    if(pts>0) return {side:'A', pids:pids.filter(pid=>A.indexOf(pid)>=0)};
    if(pts<0) return {side:'B', pids:pids.filter(pid=>B.indexOf(pid)>=0)};
    return {side:null,pids:[]};
  }
}

// Force a given hole to be a push (zero effect) for one game:
// - make every player's NET equal (gross = strokes + 100)
// - clear junk on that hole
function equalizeHoleToZero(game, hole){
  var g2 = cloneGame(game);
  var ids = [].concat(g2.teamA||[], g2.teamB||[]);
  for(var i=0;i<ids.length;i++){
    var pid = ids[i];
    var s = strokesFor(g2, pid, hole) || 0;
    if(!g2.gross[pid]) g2.gross[pid] = make18(null);
    g2.gross[pid][hole] = s + 100; // everyone nets to 100 → pure push
    if(!g2.junkCounts[pid]) g2.junkCounts[pid] = make18(0);
    g2.junkCounts[pid][hole] = 0;  // no junk on the neutralized hole
  }
  return g2;
}

// Total Team A net across all games
function aggregateActualTotal(state){
  var tot=0;
  for(var gi=0; gi<state.games.length; gi++){
    tot += computeGameResult(state.games[gi]).teamTotals.total;
  }
  return tot;
}

// Counterfactual total when a specific hole is neutralized in every game
function aggregateCounterfactualForHole(state, hole){
  var tot=0;
  for(var gi=0; gi<state.games.length; gi++){
    var g = state.games[gi];
    var g2 = equalizeHoleToZero(g, hole);
    tot += computeGameResult(g2).teamTotals.total;
  }
  return tot;
}

// Also compute per-game contribution to the swing for attribution
function perGameContributionForHole(state, hole){
  var contrib=[];
  for(var gi=0; gi<state.games.length; gi++){
    var g = state.games[gi];
    var actual = computeGameResult(g).teamTotals.total;
    var cf = computeGameResult(equalizeHoleToZero(g, hole)).teamTotals.total;
    contrib.push({gi:gi, delta: actual - cf, game:g});
  }
  contrib.sort((a,b)=>Math.abs(b.delta)-Math.abs(a.delta));
  return contrib;
}

// Build the per-hole, aggregate highlights
function buildZeroHighlights(state){
  var lines=[];
  var actualAll = aggregateActualTotal(state);
  for(var h=0; h<18; h++){
    // If nobody has scores on this hole anywhere, skip quick
    var hasAny=false;
    for(var gi=0; gi<state.games.length && !hasAny; gi++){
      var g=state.games[gi], ids=[].concat(g.teamA||[], g.teamB||[]);
      for(var i=0;i<ids.length;i++){
        var v=g.gross[ids[i]] && g.gross[ids[i]][h];
        if(v!=null){ hasAny=true; break; }
      }
    }
    if(!hasAny) continue;

    var cfAll = aggregateCounterfactualForHole(state, h);
    var swing = actualAll - cfAll; // >0 means toward Team A
    if(!swing) continue;

    // Find the game that contributed most to this hole’s swing
    var contrib = perGameContributionForHole(state, h);
    var top = contrib[0];
    var toward = swing>0 ? 'Team A' : 'Team B';

 // Attribution: allow multiple players; ALWAYS label by what each player scored (birdie/par/etc),
// even if junk drove the swing.
var swingSign = swing > 0 ? 1 : -1;
var per = perPlayerContributionForHole(top.game, h);

// Keep only contributors whose marginal delta points the same way as the overall swing.
// If none, fall back to everyone.
var sameDir = per.filter(p => Math.sign(p.delta) === swingSign);
if (!sameDir.length && per.length) sameDir = per.slice();

// Find the largest absolute marginal impact among those, include all ties.
var topAbs = 0;
for (var i = 0; i < sameDir.length; i++) topAbs = Math.max(topAbs, Math.abs(sameDir[i].delta));
var EPS = 1e-9;
var tied = sameDir.filter(p => Math.abs(Math.abs(p.delta) - topAbs) <= EPS);

// Helper: score label for a player on this hole
function labelForPid(pid){
  var parVal = (state.course && state.course.par && state.course.par[h] != null)
                ? +state.course.par[h] : null;
  var gross = top.game.gross[pid] && top.game.gross[pid][h];
  if (parVal == null || gross == null) return '';     // unknown → no label
  var lab = eventLabelForScore(gross, parVal);        // 'birdie', 'bogey', etc. null → par
  if (lab == null && gross === parVal) lab = 'par';
  return lab || '';
}

// Simple pluralizer for uniform multi-player labels
function pluralizeLabel(s){
  if (s === 'par') return 'pars';
  if (s === 'birdie') return 'birdies';
  if (s === 'eagle') return 'eagles';
  if (s === 'bogey') return 'bogeys';
  if (s === 'double bogey') return 'double bogeys';
  if (s === 'albatross') return 'albatrosses';
  return s ? (s + 's') : s;
}

// Names + labels
var whoPids = tied.map(t => t.pid);
var names   = whoPids.map(playerName);
var labels  = whoPids.map(labelForPid).map(s => s || ''); // ensure strings

// Build `whoText`:
//  - If all labels equal and non-empty: "P1 & P2's birdies"
//  - If mixed labels: "P1 birdie & P2 par" (attach label to each name)
//  - If labels missing: just list names ("P1 & P2")
var allSame = labels.length && labels.every(l => l && l === labels[0]);
var whoText;
if (labels.length === 1){
  whoText = names[0] + (labels[0] ? (' ' + labels[0]) : '');
} else if (allSame){
  whoText = names.join(' & ') + (labels[0] ? ("'s " + pluralizeLabel(labels[0])) : '');
} else {
  var parts = [];
  for (var i = 0; i < names.length; i++){
    parts.push(names[i] + (labels[i] ? (' ' + labels[i]) : ''));
  }
  whoText = parts.join(' & ');
  var who = whoText; // fix: align with lines.push(...) expecting `who`

}


// (result uses `who` and optional `tag`; example text added below)
// lines.push({
//   hole:h,
//   value:Math.abs(swing),
//   swing:swing,
//   text:`Hole ${h+1}: ${who}${tag ? (" " + tag) : ""} swung ${fmt(Math.abs(swing))} toward ${toward}`
// });



    lines.push({
      hole:h,
      value:Math.abs(swing),
      swing:swing,
      text:`Hole ${h+1}: ${whoText} swung ${fmt(Math.abs(swing))} toward ${toward}`

    });
  }

  // Rank biggest swings first (later holes tie-break)
  lines.sort((a,b)=> (b.value-a.value) || (b.hole-a.hole));
  return lines;
}

// UI: simple list with Min$/TopN controls (same knobs as before)
function renderTextHighlights(){
  if(!state.settings) state.settings={};
  if(typeof state.settings.thTop !== 'number') state.settings.thTop = 12;
  if(typeof state.settings.thMin !== 'number') state.settings.thMin = 5;

  var all = buildZeroHighlights(state).filter(x=>x.value >= state.settings.thMin);
  all = all.slice(0, state.settings.thTop);

  var box = h('div',{class:'card'},[
    h('div',{class:'row',style:'justify-content:space-between;align-items:center;'},[
      h('div',{class:'pill'},'Highlights (hole vs zero)'),
      h('div',{},[
        h('label',{},['Min $ ',
          h('input',{type:'number',value:state.settings.thMin,style:'width:80px;padding:4px 6px;',
            oninput:function(e){ state.settings.thMin = +e.target.value||0; render(); }})
        ]),
        h('label',{style:'margin-left:8px;'},['Top ',
          h('input',{type:'number',value:state.settings.thTop,style:'width:64px;padding:4px 6px;',
            oninput:function(e){ state.settings.thTop = Math.max(1,+e.target.value||1); render(); }})
        ])
      ])
    ]),
    (all.length
      ? h('ul',{}, all.map(x=>h('li',{}, x.text)))
      : h('div',{class:'muted',style:'padding:8px 0;'},'No highlights yet.'))
  ]);

  return h('div',{},[box]);
}

// Force ONLY one player's hole to neutral (nets equal) + clear that player's junk on that hole
function equalizeHoleForSinglePlayer(game, hole, pid){
  var g2 = cloneGame(game);
  var s = strokesFor(g2, pid, hole) || 0;
  if(!g2.gross[pid]) g2.gross[pid] = make18(null);
  g2.gross[pid][hole] = s + 100;       // this player pushes the hole
  if(!g2.junkCounts[pid]) g2.junkCounts[pid] = make18(0);
  g2.junkCounts[pid][hole] = 0;        // remove their junk for this hole
  return g2;
}

// In one game, measure each player's marginal $ contribution on this hole
function perPlayerContributionForHole(game, hole){
  var actual = computeGameResult(game).teamTotals.total;
  var ids = [].concat(game.teamA||[], game.teamB||[]);
  var out = [];
  for(var i=0;i<ids.length;i++){
    var pid = ids[i];
    // If they didn’t post a gross here and have no junk, skip quick
    var hasGross = game.gross[pid] && game.gross[pid][hole]!=null;
    var hasJunk = (game.junkCounts[pid]||[])[hole] > 0;
    if(!hasGross && !hasJunk) continue;

    var cfGame = equalizeHoleForSinglePlayer(game, hole, pid);
    var cf = computeGameResult(cfGame).teamTotals.total;
    out.push({ pid: pid, delta: actual - cf }); // positive => toward Team A
  }
  // biggest absolute first
  out.sort(function(a,b){ return Math.abs(b.delta) - Math.abs(a.delta); });
  return out;
}


  // ===== Tabs =====
  function Tabs(){
    function mk(id,label){ return h('button',{class:'btn '+(state.tab===id?'active primary':''), onclick:function(){ if(document.activeElement&&document.activeElement.blur){ try{document.activeElement.blur();}catch(_e){} } state.tab=id; render(); }}, label); }
   var node=h('div',{class:'tabs'},[
  mk('setup','SETUP'),
  mk('scores','SCORES'),
  mk('junk','JUNK'),
  mk('status','STATUS'),
  mk('game','GAME'),
  mk('transactions','TRANSACTIONS'),
   mk('highlights','HIGHLIGHTS'),   // ⬅️ new
  
]);

    var root=document.getElementById('tabs'); root.innerHTML=''; root.appendChild(node);
  }

  // ===== UI fragments =====
  function strokeDots(pid,hole){
    var dots=[];
    for(var gi=0; gi<Math.min(6,state.games.length); gi++){ 
      var g=state.games[gi]; var inA=(g.teamA||[]).indexOf(pid)>=0, inB=(g.teamB||[]).indexOf(pid)>=0;
      if(!inA && !inB) continue;
      var s=strokesFor(g,pid,hole); if(s>0) dots.push(h('span',{class:'dot g'+(gi+1)},''));
    }
    if(!dots.length) return null;
    return h('span',{class:'dots'},dots);
  }

  // ===== Screens =====
  function screenSetup(){
    // Players
    var playerRows=[];
    for(var i=0;i<state.players.length;i++){
      (function(p){
        playerRows.push(h('div',{style:'display:grid; grid-template-columns:64px 1fr; gap:8px; align-items:center;'},[
          h('span',{class:'muted',style:'text-align:right;'},p.id),
          h('input',{type:'text',value:p.name,
            onfocus:beginEdit,
            oninput:function(e){ p.name=e.target.value; },
            onblur:function(e){ p.name=e.target.value; endEdit(); }
          })
        ]));
      })(state.players[i]);
    }
    var playersCard=h('div',{class:'card'},[
      h('div',{class:'pill'},'Players (rename)'),
      h('div',{},playerRows)
    ]);

    // Course Handicap block (unchanged)
    function courseCard(){
      var header=h('div',{class:'pill'},'Course Handicap');
      var sel=h('select',{onchange:function(e){ applyPresetByName(e.target.value); }});
      Object.keys(COURSE_PRESETS).forEach(function(name){ sel.appendChild(h('option',{value:name,selected:(name===state.course.name)},name)); });
      var nameRow=h('div',{class:'note',id:'courseNameRow'},'Loaded: '+(state.course.name||'—'));

      var head=[h('th',{class:'sticky'},'HOLE')];
      for(var ci=0; ci<18; ci++) head.push(h('th',{},String(ci+1)));
      var parRow=[h('td',{class:'sticky'},'PAR')];
for(var ph=0; ph<18; ph++){
  (function(hole){
    parRow.push(h('td',{},[
      h('input',{
        type:'tel', inputmode:'numeric', pattern:'[0-9]*',
        value:(state.course.par && state.course.par[hole]!=null)? state.course.par[hole] : '',
        style:'width:56px;text-align:center;',
        onfocus:beginEdit,
        oninput:function(e){
          var d=e.target.value.replace(/[^0-9]/g,'');
          if(d!==e.target.value) e.target.value=d;
        },
        onblur:function(e){
          var d=e.target.value.replace(/[^0-9]/g,'');
          var n=parseInt(d||'4',10);
          if(!isFinite(n)) n=4;
          n=Math.max(3,Math.min(6,n)); // typical par 3–6
          if(!state.course.par) state.course.par=make18(4);
          state.course.par[hole]=n;
          e.target.value=String(n);
          endEdit();
        }
      })
    ]));
  })(ph);
}

      var row=[h('td',{class:'sticky'},'HCP')];
      
      for(var hci=0; hci<18; hci++){
        (function(hole){
          row.push(h('td',{},[
            h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',
              value:state.course.hcp[hole],
              style:'width:56px;text-align:center;',
              onfocus:beginEdit,
              oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
              onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); var n=parseInt(d||'1',10); if(!isFinite(n)) n=1; n=Math.max(1,Math.min(18,n)); state.course.hcp[hole]=n; e.target.value=String(n); endEdit(); }
            })
          ]));
        })(hci);
      }
      var tableWrap=h('div',{class:'card scroll'},[
        h('table',{},[
          h('thead',{},[h('tr',{},head)]),
         h('tbody',{},[ h('tr',{},parRow), h('tr',{},row) ])

        ])
      ]);
      var saveBtn=h('button',{class:'btn small',onclick:function(){
        var nm=prompt('Name this preset:',''); if(!nm) return; COURSE_PRESETS[nm]={ hcp: state.course.hcp.slice(), par: (state.course.par||make18(4)).slice() };
 state.course.name=nm; queueSave(); render(); alert('Saved preset: '+nm);
      }},'Save as New Preset');

      return h('div',{class:'card'},[ header, h('div',{style:'margin-top:8px;'},sel), h('div',{style:'margin-top:6px;'},nameRow), h('div',{style:'margin-top:8px;'},tableWrap), h('div',{style:'margin-top:8px;'},saveBtn) ]);
    }

    // Team buttons (respect teamSize)
    function teamButtons(game,key){
      var wrap=h('div',{class:'row'},[]);
      for(var i=0;i<state.players.length;i++){
        (function(p){
          var team=(key==='A'?game.teamA:game.teamB);
          var on=team.indexOf(p.id)>=0; var limit=game.teamSize||2; var full=!on && team.length>=limit;
          wrap.appendChild(h('button',{
            class:'btn small '+(on?'primary':''),
            disabled:full,
            onclick:function(){
              if(document.activeElement&&document.activeElement.blur){ try{document.activeElement.blur();}catch(_e){} }
              var arr=(key==='A'?game.teamA:game.teamB);
              var idx=arr.indexOf(p.id);
              if(idx>=0) arr.splice(idx,1);
              else if(arr.length<limit) arr.push(p.id);
              queueSave(); render();
            }},p.name));
        })(state.players[i]);
      }
      return wrap;
    }

   function strokesEditor(game){
  function teamRow(label, ids){
    // Section label (e.g., "Team A:")
    const header = h('div',{class:'muted', style:'margin:6px 0 8px;'}, label);

    // Responsive grid of player tiles; names sit ABOVE the input
    const grid = h('div',{
      style:[
        'display:grid',
        'gap:12px',
        'grid-template-columns:repeat(auto-fit, minmax(96px, 1fr))',
        'align-items:start'
      ].join(';')
    },[]);

    for (var i=0; i<ids.length; i++){
      (function(pid){
        grid.appendChild(
          h('div',{
            // a simple vertical tile; no extra card/border so it blends in
            style:'display:flex; flex-direction:column; gap:6px;'
          },[
            // Player name above; wraps safely without widening the input
            h('div',{
              class:'muted',
              style:'text-align:center; font-size:12px; line-height:1.2; word-break:break-word;'
            }, playerName(pid)),

            // Strokes input (full-width so it doesn’t wrap)
            h('input',{
              type:'tel', inputmode:'numeric', pattern:'[0-9]*',
              value: game.strokesCount[pid]||0,
              style:'width:100%; text-align:center; padding:8px 10px;',
              onfocus: beginEdit,
              oninput: function(e){
                var d=e.target.value.replace(/[^0-9]/g,'');
                if(d!==e.target.value) e.target.value=d;
              },
              onblur: function(e){
                var d=e.target.value.replace(/[^0-9]/g,'');
                game.strokesCount[pid]=parseInt(d||'0',10)||0;
                e.target.value=String(game.strokesCount[pid]||0);
                endEdit();
              }
            })
          ])
        );
      })(ids[i]);
    }

    return h('div',{},[header, grid]);
  }

  var anyA = (game.teamA||[]).length;
  var anyB = (game.teamB||[]).length;

  var body = [];
  if(anyA) body.push( teamRow('Team A:', game.teamA) );
  if(anyB) body.push( teamRow('Team B:', game.teamB) );
  if(!anyA && !anyB){
    body.push(h('div',{class:'note'},'Pick players for each team to edit strokes.'));
  } else {
    body.push(h('div',{class:'note'},'Strokes apply on HCP 1…n across 18.'));
  }

  return h('div',{class:'card'},[
    h('div',{class:'pill'},'Strokes (per player for this game)'),
    h('div',{}, body)
  ]);
}


    var gamesCardChildren=[
      h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
        h('div',{class:'pill'},'Games'),
        h('div',{},[
          h('button',{class:'btn small',onclick:function(){ var ng=makeNewGame(true); state.games.push(ng); state.activeGameId=ng.id; render(); }},'Add Game')
        ])
      ])
    ];

    for(var gi=0; gi<state.games.length; gi++){
      (function(g,idx){
        var shapeClass='shape-g'+(((idx)%6)+1);
        var card=h('div',{class:shapeClass},[
          h('div',{class:'card'},[
            h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
              h('div',{class:'pill'},gameShortLabel(g)),
              h('div',{},[
                h('button',{class:'btn small',onclick:function(){ state.activeGameId=g.id; state.tab='scores'; render(); }},'Go to SCORES'),
                h('button',{class:'btn small',style:'margin-left:6px;',onclick:function(){ var idx0=state.games.indexOf(g); if(idx0>=0) state.games.splice(idx0,1); if(!state.games.length) state.games.push(makeNewGame(false)); state.activeGameId=state.games[0].id; render(); }},'Delete')
              ])
            ]),

// NEW: Nassau Scoring + Team Size (always side-by-side on phones)
h('div',{class:'game-options-row', style:'margin:6px 0;'},[
 h('div',{},[
  h('div',{class:'muted nowrap'},'Nassau Scoring'),
  h('label',{class:'radio-nowrap', style:'display:block; margin-top:6px;'},[
    h('input',{type:'radio',name:'mode_'+g.id,checked:g.scoringMode==='hi_low',
      onchange:function(){ g.scoringMode='hi_low'; queueSave(); render(); }}),' Hi/Low'
  ]),
  h('label',{class:'radio-nowrap', style:'display:block; margin-top:6px;'},[
    h('input',{type:'radio',name:'mode_'+g.id,checked:g.scoringMode==='low_net',
      onchange:function(){ g.scoringMode='low_net'; queueSave(); render(); }}),' Best Ball'
  ])
]),
h('div',{style:'padding-left:8px;'},[
  h('div',{class:'muted nowrap'},'Team Size'),
  h('label',{class:'radio-nowrap', style:'display:block; margin-top:6px;'},[
    h('input',{type:'radio',name:'ts_'+g.id,checked:(g.teamSize||2)===2,
      onchange:function(){ g.teamSize=2; queueSave(); render(); }}),' 2v2'
  ]),
  h('label',{class:'radio-nowrap', style:'display:block; margin-top:6px;'},[
    h('input',{type:'radio',name:'ts_'+g.id,checked:(g.teamSize||2)===1,
      onchange:function(){ g.teamSize=1; g.teamA=g.teamA.slice(0,1); g.teamB=g.teamB.slice(0,1); queueSave(); render(); }}),' 1v1'
  ])
])
]),

// Note block (below row)
(g.scoringMode==='hi_low' && (g.teamSize||2)===1
  ? h('div',{style:'margin-top:4px;'},[
      h('div',{class:'note'},'Hi/Low needs 2v2. Until each side has 2 players, holes are scored as Best Ball for presses and status.')
    ])
  : h('div',{})),

            h('div',{class:'grid grid-2'},[
              h('div',{},[ h('div',{class:'muted'},'Team A (pick '+(g.teamSize||2)+')'), teamButtons(g,'A') ]),
              h('div',{},[ h('div',{class:'muted'},'Team B (pick '+(g.teamSize||2)+')'), teamButtons(g,'B') ])
            ]),

            h('div',{class:'grid grid-3'},[
              h('div',{},[ h('div',{class:'muted'},'Front $'),
                h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*', value:g.stakes.front,
                  onfocus:beginEdit,
                  oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
                  onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.front=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.front); endEdit(); }
                })
              ]),
              h('div',{},[ h('div',{class:'muted'},'Back $'),
                h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*', value:g.stakes.back,
                  onfocus:beginEdit,
                  oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
                  onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.back=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.back); endEdit(); }
                })
              ]),
              h('div',{},[ h('div',{class:'muted'},'Overall $'),
                h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*', value:g.stakes.overall,
                  onfocus:beginEdit,
                  oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
                  onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.overall=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.overall); endEdit(); }
                })
              ])
            ]),

            h('div',{class:'grid grid-3'},[
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.front, onclick:function(e){ g.autoPress.front=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ]),
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.back, onclick:function(e){ g.autoPress.back=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ]),
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.overall, onclick:function(e){ g.autoPress.overall=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ])
            ]),

            // Junk $/point
            h('div',{class:'row',style:'align-items:center; gap:12px; margin-top:8px; margin-bottom:12px;'},[
                h('div',{class:'pill'},'Junk $/point'),
              h('div',{},[
                h('div',{class:'muted'},'Front'),
                h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*', value:g.junkValue.front, style:'width:64px;text-align:center;',
                  onfocus:beginEdit,
                  oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
                  onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.junkValue.front=parseInt(d||'0',10)||0; e.target.value=String(g.junkValue.front); endEdit(); }
                })
              ]),
              h('div',{},[
                h('div',{class:'muted'},'Back'),
                h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*', value:g.junkValue.back, style:'width:64px;text-align:center;',
                  onfocus:beginEdit,
                  oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
                  onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.junkValue.back=parseInt(d||'0',10)||0; e.target.value=String(g.junkValue.back); endEdit(); }
                })
              ])
            ]),

            strokesEditor(g),
            h('div',{class:'note'},'Scores tab shows GROSS only. Net is auto from strokes + course HCP.')
          ])
        ]);
        gamesCardChildren.push(card);
      })(state.games[gi],gi);
    }

    return h('div',{},[ playersCard, courseCard(), h('div',{},gamesCardChildren) ]);
  }

  function screenScores(){
    var g0=state.games[0];
    var lastHole=-1;
    try{
      for(var holeI=0; holeI<18; holeI++){
        for(var pi=0; pi<state.players.length; pi++){
          var pid=state.players[pi].id, v=g0 && g0.gross && g0.gross[pid] ? g0.gross[pid][holeI] : null;
          if(v!=null && v!=='') lastHole=holeI;
        }
      }
    }catch(_e){}

    function updateSums(pid){
      var arr=g0.gross[pid], f=sumGrossRange(arr,0,8), b=sumGrossRange(arr,9,17), tot=(f==null && b==null)? null : ((f||0)+(b||0));
      var fEl=document.getElementById('sumF_'+pid), bEl=document.getElementById('sumB_'+pid), tEl=document.getElementById('sumT_'+pid);
      if(fEl) fEl.textContent=(f==null?'':String(f));
      if(bEl) bEl.textContent=(b==null?'':String(b));
      if(tEl) tEl.textContent=(tot==null?'':String(tot));
    }

   function grossInput(pid,hole,rowIdx){
  var tabIndex = (hole * state.players.length) + rowIdx + 1; // column-major order
  return h('input',{
    type:'tel',inputmode:'numeric',pattern:'[0-9]*',placeholder:'-',
    tabindex: tabIndex,
    value:(g0.gross[pid][hole]==null?'':String(g0.gross[pid][hole])),
    onfocus:beginEdit,
    oninput:function(e){
      var d=e.target.value.replace(/[^0-9]/g,''); 
      if(d!==e.target.value) e.target.value=d;
      var v=(d==='')?null:parseInt(d,10);

      // write-through to ALL games (your existing logic)
      for(var gi=0; gi<state.games.length; gi++){
        state.games[gi].gross[pid][hole]=(isNaN(v)?null:v);
      }

      // 🔹 NEW: keep currentHole synced while typing
      state.ui.currentHole = getLastScoredHole0Based();
    },
    onkeydown:function(e){
      if(e.key==='Enter'){
        e.preventDefault();
        var nextTab = tabIndex + 1;
        var maxInCol = (hole+1)*state.players.length;
        if(nextTab>maxInCol)
          nextTab = (hole+1<18) ? ((hole+1)*state.players.length - (state.players.length-1)) : tabIndex;
        var next = document.querySelector('input[tabindex="'+nextTab+'"]');
        if(next) next.focus();
      }
    },
    onblur:function(e){
      var d=e.target.value.replace(/[^0-9]/g,''); 
      var v=(d==='')?null:parseInt(d,10);

      // write-through to ALL games (your existing logic)
      for(var gi=0; gi<state.games.length; gi++){
        state.games[gi].gross[pid][hole]=(isNaN(v)?null:v);
      }

      e.target.value=(v==null?'':String(v));
      updateSums(pid);

      // 🔹 NEW: also update on blur (covers paste/edits)
      state.ui.currentHole = getLastScoredHole0Based();

      endEdit();
    }
  });
}


    var head=[h('th',{class:'sticky'},'Hole')];
    for(var hi=0; hi<18; hi++) head.push(h('th',{id:'col_h_'+hi},String(hi+1)));
    head.push(h('th',{},'F'),h('th',{},'B'),h('th',{},'TOT'));

    var rows=[];
    for(var i=0;i<state.players.length;i++){
      (function(p,rowIdx){
        var cells=[h('td',{class:'sticky'},p.name)];
        for(var hh=0; hh<18; hh++){
          cells.push(h('td',{},[
            h('div',{class:'cellWrap'},[
              grossInput(p.id,hh,rowIdx),
              strokeDots(p.id,hh) || ''
            ])
          ]));
        }
        var arr=g0.gross[p.id], f=sumGrossRange(arr,0,8), b=sumGrossRange(arr,9,17), tot=(f==null && b==null)? null : ((f||0)+(b||0));
        cells.push(h('td',{id:'sumF_'+p.id},(f==null?'':String(f))));
        cells.push(h('td',{id:'sumB_'+p.id},(b==null?'':String(b))));
        cells.push(h('td',{id:'sumT_'+p.id},(tot==null?'':String(tot))));
        rows.push(h('tr',{},cells));
      })(state.players[i], i);
    }

    var parHead=[h('th',{class:'sticky'},'Par')];
for(var hi2=0; hi2<18; hi2++){
  parHead.push(h('th',{}, String((state.course.par && state.course.par[hi2]!=null) ? state.course.par[hi2] : '')));
}
// keep F/B/T columns aligned
parHead.push(h('th',{},''), h('th',{},''), h('th',{},''));

var thead=h('thead',{},[ h('tr',{},head), h('tr',{},parHead) ]);
var tbody=h('tbody',{},rows);

    var scroller=h('div',{class:'card scroll',id:'scoresScroll'},[ h('table',{},[thead,tbody]) ]);

    var root=h('div',{},[
      h('div',{class:'row',style:'align-items:center;'},[
        h('div',{class:'pill'},'Entering GROSS for all players'),
        h('div',{class:'note'},'Sums update when you leave a cell.')
      ]),
      scroller
    ]);

    setTimeout(function(){ try{ if(lastHole>=0){ var col=document.getElementById('col_h_'+lastHole), sc=document.getElementById('scoresScroll'); if(col && sc){ var target=Math.max(0, col.offsetLeft - sc.clientWidth*0.2); sc.scrollLeft=target; } } }catch(_e){} },0);

    return root;
  }

  function screenStatus(){
    function diffsArray(g){ var a=[]; for(var i=0;i<18;i++) a.push(holeDiff(g,i)); return a; }
    function curLine(diffs,line){ var sum=0,saw=false; for(var h=line.start; h<=line.end; h++){ var d=diffs[h]; if(d==null) break; saw=true; sum+=d; } return saw?sum:null; }
    function junkPointsForRange(g, teamPids, start, end){ var t=0; for(var i=0;i<teamPids.length;i++){ var pid=teamPids[i], arr=(g.junkCounts[pid]||[]); for(var h=start; h<=end; h++) t += (+arr[h]||0); } return t; }

    function seg(g,label,start,end,autoKey){
      var sg = buildSegmentLines(g,start,end,0,!!g.autoPress[autoKey]);
      var diffs = diffsArray(g);
      var parts=[], any=false;
      for(var i=0;i<sg.lines.length;i++){
        var L=sg.lines[i]; var c=curLine(diffs,L);
        if(c===null){ parts.push('—'); } else { any=true; parts.push(c>0?('+'+c):(c<0?String(c):'E')); }
      }
      var betsText = any? parts.join(' / ') : '—';
      var aPts = junkPointsForRange(g, g.teamA||[], start, end);
      var bPts = junkPointsForRange(g, g.teamB||[], start, end);

      return h('div',{class:'card'},[
        h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
          h('div',{class:'muted'},label),
          h('div',{class:'pill'},[ h('div',{},'Bets: '+betsText), h('div',{},'Junk: A='+aPts+' B='+bPts) ])
        ])
      ]);
    }

    var blocks=[ h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
      h('label',{},[ h('input',{type:'checkbox',checked:!!state.debugStatus,onclick:function(e){ state.debugStatus=!!e.target.checked; queueSave(); render(); }}), ' Show debug details' ])
    ]) ];

    for(var gi=0; gi<state.games.length; gi++){
      (function(g,idx){
        var theme='theme-g'+(((idx)%6)+1);
        blocks.push(h('div',{class:theme},[
          h('div',{class:'card'},[
            h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
              h('div',{class:'pill'},gameShortLabel(g)),
              h('div',{class:'note'},'Positive = Team A')
            ]),
            h('div',{class:'note'}, 'A: '+(g.teamA||[]).map(playerName).join(' & ')+'  |  B: '+(g.teamB||[]).map(playerName).join(' & ')),
            seg(g,'Front (1–9)',    0, 8, 'front'),
            seg(g,'Back (10–18)',   9,17, 'back'),
            seg(g,'Overall (1–18)', 0,17, 'overall')
          ])
        ]));
      })(state.games[gi],gi);
    }
    return h('div',{},blocks);
  }

  function screenJunk(){
    var targetHole = (state.ui && Number.isInteger(state.ui.currentHole)) ? state.ui.currentHole : -1;
if (targetHole < 0) targetHole = getLastScoredHole0Based();

    var blocks = [];
    for (var gi = 0; gi < state.games.length; gi++){
      (function(g, idx){
        var pids = [].concat(g.teamA || [], g.teamB || []);
        var theme = 'theme-g' + (((idx) % 6) + 1);
        var baseTab = idx * 10000;

        function junkInput(pid, hole, rowIdx, gRef){
          if(!gRef.junkCounts[pid]) gRef.junkCounts[pid] = make18(0);
          var cur = gRef.junkCounts[pid][hole]; if(!Number.isFinite(cur)) { cur = 0; gRef.junkCounts[pid][hole] = 0; }
          var displayVal   = (cur === 0 ? '' : String(cur));
          var displayBadge = (cur === 0 ? '' : String(cur));
          var badge = h('span', { class:'junkVal' }, displayBadge);
          var tabIndex = baseTab + (hole * pids.length) + rowIdx + 1;
          return h('div', { class:'junkWrap' }, [
            h('input',{
              class:'junkBox', type:'text', inputmode:'numeric', pattern:'[0-9]*', autocomplete:'off', placeholder:'-', tabindex: tabIndex, value: displayVal,
              oninput: function(e){ var digits = e.target.value.replace(/[^0-9]/g,''); if(digits !== e.target.value) e.target.value = digits; var v = (digits === '') ? 0 : parseInt(digits,10); gRef.junkCounts[pid][hole] = v; badge.textContent = (v === 0 ? '' : String(v)); try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){} },
              onkeydown: function(e){ if(e.key==='Enter'){ e.preventDefault(); var nextTab = tabIndex + 1; var colEnd  = baseTab + ((hole+1)*pids.length); if(nextTab>colEnd){ nextTab = baseTab + ((hole+1)*pids.length - (pids.length-1)); } var next = document.querySelector('input[tabindex="'+nextTab+'"]'); if(next) next.focus(); } },
              onblur: function(e){ var digits = e.target.value.replace(/[^0-9]/g,''); var v = (digits === '') ? 0 : parseInt(digits,10); gRef.junkCounts[pid][hole] = v; e.target.value = (v === 0 ? '' : String(v)); badge.textContent = (v === 0 ? '' : String(v)); try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){} }
            }),
            badge
          ]);
        }

        var head = [ h('th', { class:'sticky' }, 'Hole') ];
        for (var j=0; j<18; j++){
  head.push(h('th', { id: 'junk_col_'+idx+'_'+j }, String(j+1)));
}


        var rows = [];
        for (var i=0; i<pids.length; i++){
          (function(pid,rowIdx){
            var cells=[ h('td', { class:'sticky' }, playerName(pid)) ];
            for (var hIdx=0; hIdx<18; hIdx++){ cells.push( h('td', {}, [ junkInput(pid, hIdx, rowIdx, g) ]) ); }
            rows.push( h('tr', {}, cells) );
          })(pids[i], i);
        }

        var thead  = h('thead', {}, [ h('tr', {}, head) ]);
        var tbody  = h('tbody', {}, rows);
        var grid   = h('div', { class:'card scroll', id:'junkScroll_'+idx }, [ h('table', {}, [ thead, tbody ]) ]);
if (targetHole >= 0) {
  setTimeout(function(){
    try{
      var col = document.getElementById('junk_col_' + idx + '_' + targetHole);
      var sc  = document.getElementById('junkScroll_' + idx);
      if (col && sc){
        var target = Math.max(0, col.offsetLeft - sc.clientWidth*0.2);
        sc.scrollLeft = target;
      }
    }catch(_e){}
  }, 0);
}

        blocks.push( h('div', { class: theme }, [ grid ]) );
      })(state.games[gi], gi);
    }
    
    // Small note shown above all junk-entry tables
var note = h('div', { class:'note', style:'margin-bottom:8px;' },
             'Sweeps (+3) Sweeps/Quads (+6) on last Par 3');
    
    
    return h('div', {}, [ note ].concat(blocks));

  }

  function screenGame(){
    var blocks=[];
    for(var gi=0; gi<state.games.length; gi++){
      (function(g, idx){
        var res = computeGameResult(g);
        var theme = 'theme-g' + (((idx) % 6) + 1);
        function seg(label, segRes){
          var pills=[];
          for(var i=0;i<segRes.lines.length;i++){
            var L=segRes.lines[i];
            pills.push( h('div',{class:'pill'}, (L.pressedBy?'Press':'Main')+' • '+(L.start+1)+'–'+(L.end+1)+' • '+segRes.winnerByLine[i] ) );
          }
          var teamTotal = segRes.teamPayoutA; // per-player stake model already applied
          return h('div',{class:'card'},[
            h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
              h('div',{},label),
              h('div',{class:'muted'},'Net to Team A (Team/Player): '+fmtTeamPlayer(teamTotal, (g.teamA||[]).length))
            ]),
            h('div',{class:'row'},pills)
          ]);
        }
        var aN=(g.teamA||[]).map(playerName).join(' & ');
        var bN=(g.teamB||[]).map(playerName).join(' & ');
        blocks.push(
          h('div',{class:theme},[
            h('div',{class:'card'},[
              h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
                h('div',{class:'pill'}, gameShortLabel(g)),
                h('div',{class:'note'}, 'Positive = Team A')
              ]),
              h('div',{class:'note'}, 'A: '+(aN||'—')+'  |  B: '+(bN||'—')),
              seg('Front (1–9)',    res.segments.front),
              seg('Back (10–18)',   res.segments.back),
              seg('Overall (1–18)', res.segments.overall),
              h('div',{class:'card'},[ h('div',{class:'pill'}, 'Junk to Team A (Team/Player): '+fmtTeamPlayer(res.teamTotals.junk, (g.teamA||[]).length)) ]),
              h('div',{class:'card'},[ h('div',{class:'pill'}, 'Game Total to Team A (Team/Player): '+fmtTeamPlayer(res.teamTotals.total, (g.teamA||[]).length)) ])
            ])
          ])
        );
      })(state.games[gi], gi);
    }
    return h('div',{},blocks);
  }

  function screenTransactions(){
          // --- Share Button ---
    var shareBtn = h('div',{style:'margin-bottom:12px;'},[
   h('button',{
  class:'btn small share',
  onclick:function(){ shareResults(); }
},'Share Results')


    ]);

    var net={}; for(var pi=0; pi<state.players.length; pi++) net[state.players[pi].id]=0;
    var perGameRows=[];
    for(var gi=0; gi<state.games.length; gi++){
      var gm=state.games[gi], r=computeGameResult(gm), total=r.teamTotals.total; // already per-player model
      var sizeA=(gm.teamA||[]).length||1, sizeB=(gm.teamB||[]).length||1;
      var aShare=sizeA? (total/sizeA) : 0;
      var bShare=sizeB? (-total/sizeB) : 0;
      for(var t=0;t<(gm.teamA||[]).length;t++){ var idA=gm.teamA[t]; if(idA) net[idA]+=aShare; }
      for(var u=0;u<(gm.teamB||[]).length;u++){ var idB=gm.teamB[u]; if(idB) net[idB]+=bShare; }
      perGameRows.push(h('li',{}, gameShortLabel(gm)+': '+fmt(total)+' to Team A'));
    }
    var xfers=settleMinimalCash(net);
    var perList=(function(){ var arr=[]; for(var i=0;i<state.players.length;i++){ var p=state.players[i]; arr.push(h('li',{}, p.name+': '+fmt(net[p.id]))); } return arr; })();
    var xfList=(function(){ var arr=[]; for(var i=0;i<xfers.length;i++){ var t=xfers[i]; arr.push(h('li',{}, playerName(t.from)+' → '+playerName(t.to)+': '+fmt(t.amount))); } return arr; })();

    var themed=[];
    for(var gi2=0; gi2<state.games.length; gi2++){
      (function(g,idx){ var theme='theme-g'+(((idx)%6)+1); themed.push(h('div',{class:theme},[h('div',{class:'card'},[h('div',{class:'pill'}, gameShortLabel(g))]) ])); })(state.games[gi2],gi2);
    }

    return h('div',{},[
        shareBtn,
      h('div',{class:'card'},[ h('div',{class:'pill'},'Per-Game Totals (to Team A)'), (perGameRows.length? h('ul',{},perGameRows) : h('div',{class:'muted'},'No games yet.')) ]),
      h('div',{class:'card'},[ h('div',{class:'pill'},'Per-Player Net (All Games + Junk)') , h('ul',{},perList) ]),
      h('div',{class:'card'},[ h('div',{class:'pill'},'Least-Cash Transfers'), (xfers.length? h('ul',{},xfList) : h('div',{class:'muted'},'All square.')) ]),
      h('div',{},themed)
    ]);
  }

  // ===== Presets =====
function applyPresetByName(name){
  var preset = COURSE_PRESETS[name];
  var hcp = Array.isArray(preset) ? preset : (preset && preset.hcp);
  if(!Array.isArray(hcp) || hcp.length!==18){ alert('Preset must have exactly 18 handicap numbers.'); return; }
  var seen={}; for(var i=0;i<18;i++){ var n=+hcp[i]; if(!(n>=1&&n<=18)){ alert('HCP numbers must be 1–18.'); return; } if(seen[n]){ alert('Each HCP 1–18 must appear once.'); return; } seen[n]=true; }
  state.course.hcp=hcp.slice();
  state.course.name=name;
  // par optional
  var par = (preset && Array.isArray(preset.par) && preset.par.length===18) ? preset.par.slice() : make18(4);
  state.course.par = par;
  queueSave(); render();
}
function shareResults(){
  try {
    var lines = [];
    lines.push("Round Summary from Bunch Bets:");
    lines.push(""); // blank line for spacing

    // --- Player gross score summary ---
    lines.push("Player Scores:");
    for (var pi=0; pi<state.players.length; pi++){
      var p = state.players[pi];
      // use first game’s gross as the source (all games mirror the entry)
      var g0 = state.games[0];
      var arr = g0.gross[p.id] || [];
      var f = sumGrossRange(arr,0,8);
      var b = sumGrossRange(arr,9,17);
      var t = (f==null && b==null)? null : ((f||0)+(b||0));
      lines.push("  "+p.name+": "
                 +(f==null?"-":f)+" / "
                 +(b==null?"-":b)+" / "
                 +(t==null?"-":t));
    }
    lines.push(""); // blank line after scores

    // --- Game summaries ---
    for (var gi=0; gi<state.games.length; gi++){
      var gm = state.games[gi];
      var res = computeGameResult(gm);
      lines.push(gameShortLabel(gm));
      lines.push('  Front:   '+fmt(res.teamTotals.front));
      lines.push('  Back:    '+fmt(res.teamTotals.back));
      lines.push('  Overall: '+fmt(res.teamTotals.overall));
      lines.push('  Junk:    '+fmt(res.teamTotals.junk));
      lines.push('  Total:   '+fmt(res.teamTotals.total));
      lines.push('');
    }

    // --- Per-player net ---
    var net={};
    for(var pi=0; pi<state.players.length; pi++) net[state.players[pi].id]=0;
    for(var gi=0; gi<state.games.length; gi++){
      var gm=state.games[gi], r=computeGameResult(gm), total=r.teamTotals.total;
      var sizeA=(gm.teamA||[]).length||1, sizeB=(gm.teamB||[]).length||1;
      var aShare=sizeA? (total/sizeA) : 0;
      var bShare=sizeB? (-total/sizeB) : 0;
      (gm.teamA||[]).forEach(function(id){ net[id]+=aShare; });
      (gm.teamB||[]).forEach(function(id){ net[id]+=bShare; });
    }
    lines.push('Per-Player Net:');
    for (var pi=0; pi<state.players.length; pi++){
      var p=state.players[pi];
      lines.push('  '+p.name+': '+fmt(net[p.id]));
    }

    // --- Transfers ---
    var xfers=settleMinimalCash(net);
    if (xfers.length){
      lines.push('');
      lines.push('Transfers:');
      xfers.forEach(function(x){
        lines.push('  '+playerName(x.from)+' → '+playerName(x.to)+' : '+fmt(x.amount));
      });
    }

    var txt = lines.join('\n');

    // --- Share sheet on mobile (if supported) ---
    if (navigator.share){
      navigator.share({ text: txt }).catch(function(){
        alert(txt); // fallback if user cancels or it fails
      });
      return;
    }

    // --- SMS draft (if supported) ---
    var smsLink = 'sms:?&body='+encodeURIComponent(txt);
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      window.location.href = smsLink;
    } else {
      // --- Desktop fallback ---
      console.log(txt);
      alert(txt);
    }

  } catch(e){
    alert('Could not generate share text: '+e.message);
  }
}



  // ===== Render =====
  function render(){
    if(__locks>0) return;
    try{
      Tabs();
      var root=document.getElementById('app'); root.innerHTML='';
      var view;
      if(state.tab==='setup') view=screenSetup();
    else if(state.tab==='scores') view=wrapThemes(screenScores());
    else if(state.tab==='junk') view=wrapThemes(screenJunk());
    else if(state.tab==='status') view=wrapThemes(screenStatus());
    else if(state.tab==='highlights') view=wrapThemes(renderTextHighlights()); // ⬅️ add this
    else if(state.tab==='game') view=wrapThemes(screenGame());
    else if(state.tab==='transactions') view=wrapThemes(screenTransactions());
    else view=wrapThemes(screenGame());

      
      // Hide the header on all tabs except Setup
var headerEl = document.querySelector('header');
if (headerEl) headerEl.style.display = (state.tab === 'setup' ? '' : 'none');

      root.appendChild(view);
      errBox.style.display='none';
    }catch(e){ errBox.style.display='block'; errBox.textContent='Render failed: '+(e && e.message ? e.message : String(e)); console.error(e); }
  }

  function wrapThemes(viewNode){ var wrap=h('div',{},[]); wrap.appendChild(viewNode); return wrap; }

document.getElementById('resetBtn').addEventListener('click', function(){
  if(!confirm('Start a new round? Scores & junk will be cleared and teams/stakes reset. Your custom courses & presets will be kept.')) return;

  // Preserve current course + presets (and player names)
  var keepCourse  = JSON.parse(JSON.stringify(state.course || {}));
  var keepPresets = COURSE_PRESETS; // reference is fine; we reassign below

  // Fresh games with defaults; player names stay as-is
  state.games = [];
  var ng = makeNewGame(false);
  state.games = [ng];
  state.activeGameId = ng.id;

  // Restore preserved course + presets
  state.course = keepCourse;
  COURSE_PRESETS = keepPresets;

  saveState();
  render();
});


  document.getElementById('clearBtn').addEventListener('click', function(){
    if(!confirm('Clear all scores & junk for this round and remove the saved snapshot? Teams, stakes, strokes, and course stay the same.')) return;
    try{ localStorage.removeItem(STORAGE_KEY); }catch(_e){}
    for(var gi=0; gi<state.games.length; gi++){
      var g=state.games[gi];
      for(var pi=0; pi<state.players.length; pi++){
        var pid=state.players[pi].id; g.gross[pid]=make18(null); g.junkCounts[pid]=make18(0);
      }
    }
    saveState(); render(); alert('Scores & junk cleared. Saved snapshot was removed.');
  });

  render();
  document.getElementById('factoryBtn').addEventListener('click', function(){
  if(!confirm('Factory Reset will erase EVERYTHING: scores, teams, strokes, players, and ALL saved course presets. Continue?')) return;

  try { localStorage.removeItem(STORAGE_KEY); } catch(_e) {}

  // Reset players to defaults (change if you want to keep names)
  state.players = [
    {id:'p1',name:'P1'},{id:'p2',name:'P2'},{id:'p3',name:'P3'},{id:'p4',name:'P4'},{id:'p5',name:'P5'}
  ];

  // Fresh game
  state.games = [];
  var ng = makeNewGame(false);
  state.games = [ng];
  state.activeGameId = ng.id;

  // Reset course to built-in El Macero Temp
  state.course={name:'El Macero',
  hcp:[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
  par:[4,5,3,4,5,4,3,4,4,4,4,3,4,4,5,3,4,5]
};


  // Recreate built-in presets only (wipes all custom ones)
  COURSE_PRESETS = {
    'El Macero': {
      hcp:[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
      par:[4,5,3,4,5,4,3,4,4,4,4,3,4,4,5,3,4,5]
    },
    'El Macero Temp': {
      hcp:[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6],
      par:[4,5,3,4,5,4,3,4,4,4,5,3,4,5,4,3,4,4]
    }
  };

  saveState();
  render();
  alert('Factory Reset complete. All custom courses/presets were removed.');
});

})();
</script>
  <script>
(function(){
  var ua = navigator.userAgent || '';
  var isIOS = /iPad|iPhone|iPod/.test(ua) || (ua.includes('Mac') && 'ontouchend' in document);
  if (isIOS) document.documentElement.classList.add('ios');
})();
</script>

</body>
</html>
