<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#2563eb" />
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1420" />
<meta name="apple-mobile-web-app-title" content="Nassau Hi/Low by Bunch Bets (V3.0)" />

<!-- ========= ICONS & MANIFEST (GitHub raw links) =========
Replace YOUR_USER/YOUR_REPO/YOUR_BRANCH with your repo path.
Example: yourUser/yourRepo/main
-->
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon-16.png">
<link rel="icon" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/BunchBets180.png">
<link rel="mask-icon" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/safari-pinned-tab.svg" color="#2563eb">
<link rel="manifest" href="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/manifest.webmanifest" crossorigin="anonymous">
<meta name="msapplication-TileColor" content="#0f1420">
<meta name="msapplication-config" content="https://raw.githubusercontent.com/Bunch313131/nassau-app/main/browserconfig.xml" />
<!-- (Optional) Cache-bust example: add ?v=2 to any icon URL if needed. -->
<!-- ======================================================= -->

<link rel="icon" href="favicon.ico" />
<title>Nassau – Hi/Low (Build 3.0)</title>
<style>
  :root { --bg:#0b0e13; --card:#0f1420; --txt:#ecf0f6; --muted:#a3a9b6; --border:#1e2633; --acc:#3b82f6; color-scheme: light dark; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--txt); background:var(--bg); }
  header{ background:var(--card); border-bottom:1px solid var(--border); padding:10px 12px; position:sticky; top:0; z-index:10; }
  h1{ font-size:18px; margin:0; }
  main{ padding:12px; }
  .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:none; }
  .btn{ background:var(--card); border:1px solid var(--border); border-radius:999px; padding:8px 12px; cursor:pointer; color:var(--txt); }
  .btn.primary{ background:var(--acc); color:#fff; border-color:var(--acc); }
  .btn.small{ padding:6px 10px; font-size:14px; }
  .pill{ border:1px solid var(--border); padding:6px 10px; border-radius:999px; display:inline-block; background:rgba(255,255,255,0.02); }
  .grid{ display:grid; gap:8px; }
  .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .muted{ color:var(--muted); }
  input[type="text"],input[type="tel"],select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%; font-size:16px; min-height:44px; color:var(--txt); background:transparent; }
  table{ border-collapse:collapse; width:100%; font-size:14px; }
  th,td{ border:1px solid var(--border); padding:6px; text-align:center; vertical-align:top; }
  th.sticky, td.sticky{ position:sticky; left:0; background:var(--card); z-index:2; text-align:left; }
  .tabs{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 10px; }
  .tabs .btn.active{ background:var(--acc); color:#fff; border-color:var(--acc); }
  .scroll{ overflow:auto; }
  .note{ font-size:12px; color:var(--muted); }
  .error{ position:fixed; bottom:8px; left:8px; right:8px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; border-radius:12px; padding:8px 12px; font-size:12px; display:none; z-index:9999; white-space:pre-wrap; }

  /* Per-game tinted background for non-setup screens */
  .theme-g1 .card{ outline: 1px solid rgba(22,163,74,.45); background: linear-gradient(0deg, rgba(22,163,74,.08), rgba(22,163,74,.08)) var(--card); }
  .theme-g2 .card{ outline: 1px solid rgba(220,38,38,.45); background: linear-gradient(0deg, rgba(220,38,38,.08), rgba(220,38,38,.08)) var(--card); }
  .theme-g3 .card{ outline: 1px solid rgba(217,119,6,.45);  background: linear-gradient(0deg, rgba(217,119,6,.08),  rgba(217,119,6,.08))  var(--card); }

  /* Setup page shows each game's card with tint too */
  .shape-g1 .card{ outline: 1px solid rgba(22,163,74,.45); background: linear-gradient(0deg, rgba(22,163,74,.08), rgba(22,163,74,.08)) var(--card); }
  .shape-g2 .card{ outline: 1px solid rgba(220,38,38,.45); background: linear-gradient(0deg, rgba(220,38,38,.08), rgba(220,38,38,.08)) var(--card); }
  .shape-g3 .card{ outline: 1px solid rgba(217,119,6,.45);  background: linear-gradient(0deg, rgba(217,119,6,.08),  rgba(217,119,6,.08))  var(--card); }

  /* Score cell wrapper + stacked dots at right */
  .cellWrap{ position:relative; }
  .cellWrap input{ width:54px; text-align:center; padding-right:14px; }
  .cellWrap .dots{
    position:absolute; right:2px; top:4px;
    display:flex; flex-direction:column; align-items:center;
    gap:2px; font-size:12px; line-height:1; pointer-events:none; user-select:none;
  }
  .cellWrap .dot{ width:6px; height:6px; border-radius:50%; }
  .cellWrap .dot.g1{ background-color:#16a34a; }
  .cellWrap .dot.g2{ background-color:#dc2626; }
  .cellWrap .dot.g3{ background-color:#d97706; }

  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --card:#fff; --txt:#111; --muted:#666; --border:#e5e7eb; --acc:#2563eb; }
    .theme-g1 .card, .shape-g1 .card{ outline: 1px solid rgba(22,163,74,.35); background: linear-gradient(0deg, rgba(22,163,74,.10), rgba(22,163,74,.10)) var(--card); }
    .theme-g2 .card, .shape-g2 .card{ outline: 1px solid rgba(220,38,38,.35); background: linear-gradient(0deg, rgba(220,38,38,.10), rgba(220,38,38,.10)) var(--card); }
    .theme-g3 .card, .shape-g3 .card{ outline: 1px solid rgba(217,119,6,.35);  background: linear-gradient(0deg, rgba(217,119,6,.10),  rgba(217,119,6,.10))  var(--card); }
  }

  /* --- Junk input visibility/debug styles (you added earlier) --- */
  .junkWrap{ position:relative; display:inline-block; }
  .junkBox{
    width:56px;
    height:32px;
    text-align:center;
    font-variant-numeric: tabular-nums;
    font-size:16px;
    line-height:32px;
    color:#ffffff !important;
    -webkit-text-fill-color:#ffffff !important;
    caret-color:#ffffff !important;
    background: rgba(59,130,246,0.15) !important;
    border: 1px solid rgba(59,130,246,0.65) !important;
    opacity:1 !important;
    mix-blend-mode: normal !important;
    filter:none !important;
  }
  .junkVal{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    line-height:1;
    color:#ffffff;
    opacity:0.9;
    pointer-events:none;
    user-select:none;
  }
  table td input.junkBox{ opacity:1 !important; }
/* Junk input + badge fixes */
.junkWrap {
  position: relative;
}

.junkBox {
  width: 32px;
  text-align: center;
  font-size: 12px;
  padding: 2px;
}

/* Number overlay inside cell */
.junkVal {
  position: absolute;
  top: 0;
  right: 4px;
  font-size: 10px;
  pointer-events: none;
}

/* Theme-specific text colors */
body.light .junkVal {
  color: #000;  /* black for light mode */
}

body.dark .junkVal {
  color: #fff;  /* white for dark mode */
}
/* Align F and B totals vertically middle */
td[id^="junkF_"],
td[id^="junkB_"] {
  text-align: center;
  vertical-align: middle;
  font-weight: 600; /* optional: make them stand out */
}
/* One-line layout only; uses default input styles */
.junkValueBar{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:nowrap;
}

</style>
</head>
<body>
<header>
  <div class="row" style="align-items:center; justify-content:space-between;">
    <h1>Nassau – Hi/Low (Build 3.0)</h1>
    <div class="row" style="align-items:center;">
      <button class="btn small" id="resetBtn">Reset</button>
      <button class="btn small" id="clearBtn" style="margin-left:6px;">Clear Save</button>
    </div>
  </div>
</header>
<main>
  <div id="tabs" class="tabs"></div>
  <div id="app"></div>
</main>
<div id="err" class="error"></div>

<script>
(function(){
  'use strict';

  // ===== Utilities =====
  function fmt(n){ if(!isFinite(n)) return "$0.00"; var s=n<0?'-':''; n=Math.abs(n); return s+"$"+n.toFixed(2); }
  function make18(fill){ var a=[]; for(var i=0;i<18;i++) a.push(fill); return a; }
  function uid(){ return Math.random().toString(36).slice(2); }

  var errBox=document.getElementById('err');
  window.addEventListener('error', function(ev){ errBox.style.display='block'; var loc=(ev.filename?(' @ '+ev.filename+':'+ev.lineno+':'+ev.colno):''); errBox.textContent=String(ev.message||ev)+loc; });

  // ===== State & Persistence =====
  var STORAGE_KEY='nassauV26';
  var state={
    tab:'setup',
    debugStatus:false,
    players:[{id:'p1',name:'P1'},{id:'p2',name:'P2'},{id:'p3',name:'P3'},{id:'p4',name:'P4'},{id:'p5',name:'P5'}],
    games:[],
    activeGameId:null,
    course:{ name:'El Macero Temp', hcp:[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6] }
  };

  // Presets (persisted)
  var COURSE_PRESETS={
    '1–18':[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18],
    'El Macero':[7,15,9,1,11,3,17,13,5,4,2,10,8,12,14,18,6,16],
    'El Macero Temp':[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6]
  };

  function cloneForSave(){ return { tab:state.tab, debugStatus:state.debugStatus, players:state.players, games:state.games, activeGameId:state.activeGameId, course:state.course, presets:COURSE_PRESETS }; }
  function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){} }
  function loadState(){
    try{
      var raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false;
      var obj=JSON.parse(raw); if(!obj||!Array.isArray(obj.games)) return false;
      state.tab=obj.tab||state.tab; state.debugStatus=!!obj.debugStatus;
      if(Array.isArray(obj.players)) state.players=obj.players;
      if(Array.isArray(obj.games)) state.games=obj.games;
      state.activeGameId=obj.activeGameId||state.activeGameId;
      if(obj.course&&obj.course.hcp&&obj.course.hcp.length===18){ state.course.hcp=obj.course.hcp; state.course.name=obj.course.name||state.course.name; }
      if(obj.presets && typeof obj.presets==='object') COURSE_PRESETS=obj.presets;
      return true;
    }catch(_e){ return false; }
  }

  var __loaded=loadState();
  function makeNewGame(cloneFromFirst){
    var g={ id:uid(), teamA:['p1','p2'], teamB:['p3','p4'],
      stakes:{front:2,back:4,overall:2},
      autoPress:{front:true,back:true,overall:false},
      junkValue:{front:1,back:2},
      junkCounts:{}, strokesCount:{}, gross:{} };
    for(var i=0;i<state.players.length;i++){
      var pid=state.players[i].id;
      g.junkCounts[pid]=make18(0);
      g.strokesCount[pid]=0;
      var useClone = !!cloneFromFirst && state.games && state.games.length>0;
      var base = useClone ? (state.games[0].gross[pid]||make18(null)) : make18(null);
      g.gross[pid]=base.slice();
    }
    return g;
  }

  if(!__loaded || !state.games || !state.games.length){ state.games=[makeNewGame(false)]; state.activeGameId=state.games[0].id; }

  function migrateState(){
    if(!state.course || !Array.isArray(state.course.hcp) || state.course.hcp.length!==18){
      state.course={name:'El Macero Temp', hcp:[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6]};
    }
    for(var gi=0; gi<state.games.length; gi++){ state.games[gi]=sanitizeGame(state.games[gi]); }
    var hasActive=false; for(var gx=0; gx<state.games.length; gx++){ if(state.games[gx].id===state.activeGameId){ hasActive=true; break; } }
    if(!hasActive){ state.activeGameId=state.games[0].id; }
  }
  migrateState();

  var __saveTimer=null; function queueSave(){ if(__saveTimer) clearTimeout(__saveTimer); __saveTimer=setTimeout(saveState,200); }

  // ===== DOM helper =====
  function h(tag,attrs,children){
    var el=document.createElement(tag); attrs=attrs||{}; children=(children==null)?[]:(Array.isArray(children)?children:[children]);
    for(var ak in attrs){ if(!attrs.hasOwnProperty(ak)) continue; var v=attrs[ak];
      if(ak==='class') el.className=v;
      else if(ak==='style') el.setAttribute('style',v);
      else if(ak==='value'){ var vv=(v==null?'':String(v)); el.value=vv; try{ el.setAttribute('value', vv);}catch(_e){} }
      else if(ak==='checked') el.checked=!!v;
      else if(ak==='disabled') el.disabled=!!v;
      else if(ak==='selected') el.selected=!!v;
      else if(ak.slice(0,2)==='on' && typeof v==='function'){ el.addEventListener(ak.slice(2).toLowerCase(), v); }
      else el.setAttribute(ak,v);
    }
    for(var i=0;i<children.length;i++){ var ch=children[i]; if(ch==null) continue; if(typeof ch==='string') el.appendChild(document.createTextNode(ch)); else el.appendChild(ch); }
    return el;
  }

  // ===== Sanitize games =====
  function sanitizeGame(g){
    if(!g || typeof g!=='object') return makeNewGame(false);
    g.teamA = Array.isArray(g.teamA)? g.teamA.slice(0,2):[];
    g.teamB = Array.isArray(g.teamB)? g.teamB.slice(0,2):[];
    g.stakes = g.stakes || {front:2,back:4,overall:2};
    g.stakes.front=isFinite(+g.stakes.front)?+g.stakes.front:2;
    g.stakes.back=isFinite(+g.stakes.back)?+g.stakes.back:4;
    g.stakes.overall=isFinite(+g.stakes.overall)?+g.stakes.overall:2;
    g.autoPress=g.autoPress||{front:true,back:true,overall:false};
    g.autoPress.front=!!g.autoPress.front; g.autoPress.back=!!g.autoPress.back; g.autoPress.overall=!!g.autoPress.overall;
    g.junkValue=g.junkValue||{front:1,back:2};
    g.junkValue.front=isFinite(+g.junkValue.front)?+g.junkValue.front:1;
    g.junkValue.back=isFinite(+g.junkValue.back)?+g.junkValue.back:2;
    g.gross=g.gross||{}; g.junkCounts=g.junkCounts||{}; g.strokesCount=g.strokesCount||{};
    for(var i=0;i<state.players.length;i++){
      var pid=state.players[i].id;
      var ga=Array.isArray(g.gross[pid])? g.gross[pid].slice(0,18):make18(null); while(ga.length<18) ga.push(null);
      for(var k=0;k<18;k++){ var v=ga[k]; ga[k]=(v===''||v==null)?null:(isFinite(+v)?+v:null); }
      g.gross[pid]=ga;
      var ja=Array.isArray(g.junkCounts[pid])? g.junkCounts[pid].slice(0,18):make18(0); while(ja.length<18) ja.push(0);
      for(var j=0;j<18;j++){ var vv=ja[j]; ja[j]=isFinite(+vv)?+vv:0; }
      g.junkCounts[pid]=ja;
      g.strokesCount[pid]=isFinite(+g.strokesCount[pid])?+g.strokesCount[pid]:0;
    }
    g.id=g.id||uid();
    return g;
  }

  // ===== Helpers =====
  var __locks=0, __rt=null;
  function beginEdit(){ __locks++; }
  function endEdit(){ __locks=Math.max(0,__locks-1); if(!__locks){ if(__rt) clearTimeout(__rt); queueSave(); __rt=setTimeout(render,120); } }
  function getGame(id){ for(var i=0;i<state.games.length;i++){ if(state.games[i].id===id) return state.games[i]; } return state.games[0]; }
  function playerName(id){ for(var i=0;i<state.players.length;i++){ if(state.players[i].id===id) return state.players[i].name; } return id; }
  function gameShortLabel(g){
    function abbr(pid, used){
      var nm=playerName(pid)||''; var hasDigits=/[0-9]/.test(nm);
      if(hasDigits){ var s=nm.toUpperCase(); if(!used[s]){ used[s]=true; return s; } }
      var base=nm.replace(/[^A-Za-z]/g,'').toUpperCase(); if(!base) base=String(pid).toUpperCase();
      for(var len=1; len<=Math.min(3,base.length); len++){ var cand=base.slice(0,len); if(!used[cand]){ used[cand]=true; return cand; } }
      var stem=base.slice(0,2)||base; var n=2; while(used[stem+n]) n++; used[stem+n]=true; return stem+n;
    }
    var used={};
    var a1=g.teamA&&g.teamA[0]?abbr(g.teamA[0],used):'', a2=g.teamA&&g.teamA[1]?abbr(g.teamA[1],used):'';
    var b1=g.teamB&&g.teamB[0]?abbr(g.teamB[0],used):'', b2=g.teamB&&g.teamB[1]?abbr(g.teamB[1],used):'';
    var left=(a1&&a2)?(a1+'/'+a2):(a1||a2||'Team A'); var right=(b1&&b2)?(b1+'/'+b2):(b1||b2||'Team B');
    return left+' vs '+right;
  }
  function gameLongLabel(game){ function nm(pid){return playerName(pid)||'?';} return (game.teamA||[]).map(nm).join(' & ')+' vs '+(game.teamB||[]).map(nm).join(' & '); }

  // ===== Strokes & scoring =====
  function strokesFor(game,pid,hole){
    var n=+game.strokesCount[pid]||0; if(!n) return 0;
    var base=Math.floor(n/18), rem=n%18, rank=+state.course.hcp[hole]||0;
    return base + ((rank>0 && rank<=rem)?1:0);
  }
  function computeNet(gross,s){ if(gross==null||!isFinite(gross)) return null; return gross - (isFinite(s||0)?(s||0):0); }
  function sumGrossRange(arr,start,end){ var t=0, any=false; for(var i=start;i<=end;i++){ var v=arr&&arr[i]; if(v!=null && isFinite(+v)){ t+=+v; any=true; } } return any? t : null; }

  // Hole diff (A perspective). Only if ALL FOUR gross scores exist.
  function holeDiff(game,hole){
    var A=game.teamA,B=game.teamB,G=game.gross; if(!A||!B||A.length!==2||B.length!==2) return null;
    var gA0=G[A[0]][hole], gA1=G[A[1]][hole], gB0=G[B[0]][hole], gB1=G[B[1]][hole];
    if(gA0==null||gA1==null||gB0==null||gB1==null) return null; // require gross present
    var a0=computeNet(gA0,strokesFor(game,A[0],hole));
    var a1=computeNet(gA1,strokesFor(game,A[1],hole));
    var b0=computeNet(gB0,strokesFor(game,B[0],hole));
    var b1=computeNet(gB1,strokesFor(game,B[1],hole));
    var aLow=Math.min(a0,a1), bLow=Math.min(b0,b1), aHigh=Math.max(a0,a1), bHigh=Math.max(b0,b1);
    var lowW=(aLow<bLow)?'A':(bLow<aLow)?'B':'T';
    var highW=(aHigh<bHigh)?'A':(bHigh<aHigh)?'B':'T';
    var d=0; if(lowW==='A') d++; else if(lowW==='B') d--; if(highW==='A') d++; else if(highW==='B') d--; return d;
  }

  function buildSegmentLines(game,start,end,stake,auto){
    var diffs=[]; for(var i=0;i<18;i++) diffs.push(holeDiff(game,i));
    var lines=[{start:start,end:end,stake:stake,pressesTriggered:0}];
    if(auto){
      for(var hIdx=start; hIdx<=end; hIdx++){
        var pressedThisHole=false;
        for(var li=0; li<lines.length; li++){
          var L=lines[li]; if(L.start>hIdx) continue;
          var cum=0, complete=true; for(var hi=L.start; hi<=hIdx; hi++){ var d=diffs[hi]; if(d==null){ complete=false; break; } cum+=d; }
          if(!complete || hIdx>=end) continue;
          var k=Math.floor(Math.abs(cum)/2);
          if(k>L.pressesTriggered){
            if(!pressedThisHole){
              var nextStart=hIdx+1; if(!lines.some(function(x){return x.start===nextStart;})){
                lines.push({start:nextStart,end:end,stake:stake,pressedBy:(cum<0?'A':'B'),pressesTriggered:0});
                pressedThisHole=true;
              }
            }
            L.pressesTriggered=k;
          }
        }
      }
    }
    var winnerByLine=[], payoutA=0;
    for(var j=0;j<lines.length;j++){
      var L2=lines[j], cum2=0, complete2=true;
      for(var hj=L2.start; hj<=L2.end; hj++){ var d2=diffs[hj]; if(d2==null){ complete2=false; break; } cum2+=d2; }
      if(!complete2){ winnerByLine.push('In-Play'); continue; }
      if(cum2>0){ winnerByLine.push('A'); payoutA+=L2.stake; }
      else if(cum2<0){ winnerByLine.push('B'); payoutA-=L2.stake; }
      else winnerByLine.push('Push');
    }
    return {lines:lines, winnerByLine:winnerByLine, payoutA:payoutA};
  }

  function computeJunk(game){
    var jv=game.junkValue||{front:0,back:0};
    function sumTeam(pids,a,b){ var t=0; for(var i=0;i<pids.length;i++){ var pid=pids[i], arr=game.junkCounts[pid]||[]; for(var hq=a; hq<=b; hq++) t+=(+arr[hq]||0); } return t; }
    var aF=sumTeam(game.teamA,0,8), aB=sumTeam(game.teamA,9,17), bF=sumTeam(game.teamB,0,8), bB=sumTeam(game.teamB,9,17);
    var aVal=aF*(+jv.front||0)+aB*(+jv.back||0), bVal=bF*(+jv.front||0)+bB*(+jv.back||0);
    return {aVal:aVal,bVal:bVal,netA:(aVal-bVal)};
  }

  // Double team totals (each loser pays full, each winner gets full)
  function computeGameResult(game){
    var seg={
      front:buildSegmentLines(game,0,8,game.stakes.front,!!game.autoPress.front),
      back:buildSegmentLines(game,9,17,game.stakes.back,!!game.autoPress.back),
      overall:buildSegmentLines(game,0,17,game.stakes.overall,!!game.autoPress.overall)
    };
    var junk=computeJunk(game);
    var frontTeam=seg.front.payoutA*2, backTeam=seg.back.payoutA*2, overallTeam=seg.overall.payoutA*2, junkTeam=junk.netA*2;
    var totalTeamA=frontTeam+backTeam+overallTeam+junkTeam;
    return {segments:seg, junk:junk, teamTotals:{front:frontTeam, back:backTeam, overall:overallTeam, junk:junkTeam, total:totalTeamA}, totalPayoutA:totalTeamA};
  }

  function settleMinimalCash(net){
    var debt=[],cred=[];
    for(var id in net){ var amt=net[id]; if(Math.abs(amt)<0.005) continue; if(amt<0) debt.push({id:id,amt:-amt}); else cred.push({id:id,amt:amt}); }
    debt.sort(function(a,b){return b.amt-a.amt;}); cred.sort(function(a,b){return b.amt-a.amt;});
    var xfers=[],i=0,j=0; while(i<debt.length && j<cred.length){
      var d=debt[i], c=cred[j], pay=Math.min(d.amt,c.amt);
      xfers.push({from:d.id,to:c.id,amount:pay}); d.amt-=pay; c.amt-=pay;
      if(d.amt<=0.005) i++; if(c.amt<=0.005) j++;
    }
    return xfers;
    
  }// Format "Team / Player" using existing currency formatter
function fmtTeamPlayer(total){
  return fmt(total) + ' / ' + fmt(total / 2);
}


  // ===== Tabs =====
  function Tabs(){
    function mk(id,label){ return h('button',{class:'btn '+(state.tab===id?'active primary':''), onclick:function(){ if(document.activeElement&&document.activeElement.blur){ try{document.activeElement.blur();}catch(_e){} } state.tab=id; render(); }}, label); }
    var node=h('div',{class:'tabs'},[ mk('setup','SETUP'), mk('scores','SCORES'), mk('junk','JUNK'), mk('status','STATUS'), mk('game','GAME'), mk('transactions','TRANSACTIONS') ]);
    var root=document.getElementById('tabs'); root.innerHTML=''; root.appendChild(node);
  }

  // ===== UI fragments =====
  function strokeDots(pid,hole){
    var dots=[];
    for(var gi=0; gi<Math.min(3,state.games.length); gi++){
      var g=state.games[gi]; var inA=(g.teamA||[]).indexOf(pid)>=0, inB=(g.teamB||[]).indexOf(pid)>=0;
      if(!inA && !inB) continue;
      var s=strokesFor(g,pid,hole); if(s>0) dots.push(h('span',{class:'dot g'+(gi+1)},''));
    }
    if(!dots.length) return null;
    return h('span',{class:'dots'},dots);
  }

  // ===== Screens =====
  function screenSetup(){
    // Players
    var playerRows=[]; for(var i=0;i<state.players.length;i++){
      (function(p){
        playerRows.push(h('div',{style:'display:grid; grid-template-columns:64px 1fr; gap:8px; align-items:center;'},[
          h('span',{class:'muted',style:'text-align:right;'},p.id),
          h('input',{type:'text',value:p.name,onfocus:beginEdit,oninput:function(e){ p.name=e.target.value; },onblur:function(e){ p.name=e.target.value; endEdit(); }})
        ]));
      })(state.players[i]);
    }
    var playersCard=h('div',{class:'card'},[ h('div',{class:'pill'},'Players (rename)'), h('div',{},playerRows) ]);

    // Course Handicap block
    function courseCard(){
      var header=h('div',{class:'pill'},'Course Handicap');
      var sel=h('select',{onchange:function(e){ applyPresetByName(e.target.value); }});
      Object.keys(COURSE_PRESETS).forEach(function(name){ sel.appendChild(h('option',{value:name,selected:(name===state.course.name)},name)); });
      var nameRow=h('div',{class:'note',id:'courseNameRow'},'Loaded: '+(state.course.name||'—'));

      var head=[h('th',{class:'sticky'},'Hole')]; for(var ci=0; ci<18; ci++) head.push(h('th',{},String(ci+1)));
      var row=[h('td',{class:'sticky'},'HCP')];
      for(var hci=0; hci<18; hci++){
        (function(hole){
          row.push(h('td',{},[
            h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',value:state.course.hcp[hole],style:'width:56px;text-align:center;',
              onfocus:beginEdit,
              oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
              onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); var n=parseInt(d||'1',10); if(!isFinite(n)) n=1; n=Math.max(1,Math.min(18,n)); state.course.hcp[hole]=n; e.target.value=String(n); endEdit(); }
            })
          ]));
        })(hci);
      }
      var tableWrap=h('div',{class:'card scroll'},[ h('table',{},[ h('thead',{},[h('tr',{},head)]), h('tbody',{},[h('tr',{},row)]) ]) ]);
      var saveBtn=h('button',{class:'btn small',onclick:function(){
        var nm=prompt('Name this preset:','');
        if(!nm) return;
        COURSE_PRESETS[nm]=state.course.hcp.slice();
        state.course.name=nm; queueSave(); render(); alert('Saved preset: '+nm);
      }},'Save as New Preset');

      return h('div',{class:'card'},[
        header,
        h('div',{style:'margin-top:8px;'},sel),
        h('div',{style:'margin-top:6px;'},nameRow),
        h('div',{style:'margin-top:8px;'},tableWrap),
        h('div',{style:'margin-top:8px;'},saveBtn)
      ]);
    }

    // Teams & stakes
    function teamButtons(game,key){
      var wrap=h('div',{class:'row'},[]);
      for(var i=0;i<state.players.length;i++){
        (function(p){
          var team=(key==='A'?game.teamA:game.teamB); var on=team.indexOf(p.id)>=0; var full=!on && team.length>=2;
          wrap.appendChild(h('button',{class:'btn small '+(on?'primary':''),disabled:full,onclick:function(){
            if(document.activeElement&&document.activeElement.blur){ try{document.activeElement.blur();}catch(_e){} }
            var arr=(key==='A'?game.teamA:game.teamB); var idx=arr.indexOf(p.id);
            if(idx>=0) arr.splice(idx,1); else if(arr.length<2) arr.push(p.id); queueSave(); render();
          }},p.name));
        })(state.players[i]);
      }
      return wrap;
    }
    function strokesEditor(game){
      var pids=[].concat(game.teamA||[],game.teamB||[]); var rows=[];
      for(var i=0;i<pids.length;i++){
        (function(pid){
          rows.push(h('div',{class:'row',style:'align-items:center; gap:12px;'},[
            h('div',{class:'muted'},playerName(pid)),
            h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',value:game.strokesCount[pid]||0,
              onfocus:beginEdit,
              oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },
              onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); game.strokesCount[pid]=parseInt(d||'0',10)||0; e.target.value=String(game.strokesCount[pid]||0); endEdit(); }
            }),
            h('div',{class:'note'},'strokes applied on HCP 1…n across 18')
          ]));
        })(pids[i]);
      }
      if(!pids.length) rows.push(h('div',{class:'note'},'Pick 2 players for each team to edit strokes.'));
      return h('div',{class:'card'},[ h('div',{class:'pill'},'Strokes (per player for this game)'), h('div',{},rows) ]);
    }

    var gamesCardChildren=[ h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},
      [h('div',{class:'pill'},'Games'), h('div',{},[h('button',{class:'btn small',onclick:function(){ var ng=makeNewGame(true); state.games.push(ng); state.activeGameId=ng.id; render(); }},'Add Game')])]) ];

    for(var gi=0; gi<state.games.length; gi++){
      (function(g,idx){
        var shapeClass=idx===0?'shape-g1':(idx===1?'shape-g2':(idx===2?'shape-g3':''));
        var card=h('div',{class:shapeClass},[
          h('div',{class:'card'},[
            h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
              h('div',{class:'pill'},gameShortLabel(g)),
              h('div',{},[
                h('button',{class:'btn small',onclick:function(){ state.activeGameId=g.id; state.tab='scores'; render(); }},'Go to SCORES'),
                h('button',{class:'btn small',style:'margin-left:6px;',onclick:function(){
                  var idx0=state.games.indexOf(g); if(idx0>=0) state.games.splice(idx0,1);
                  if(!state.games.length) state.games.push(makeNewGame(false));
                  state.activeGameId=state.games[0].id; render();
                }},'Delete')
              ])
            ]),
            h('div',{class:'grid grid-2'},[
              h('div',{},[ h('div',{class:'muted'},'Team A (pick 2)'), teamButtons(g,'A') ]),
              h('div',{},[ h('div',{class:'muted'},'Team B (pick 2)'), teamButtons(g,'B') ])
            ]),
            h('div',{class:'grid grid-3'},[
              h('div',{},[ h('div',{class:'muted'},'Front $'),   h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',value:g.stakes.front,onfocus:beginEdit,oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.front=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.front); endEdit(); }}) ]),
              h('div',{},[ h('div',{class:'muted'},'Back $'),    h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',value:g.stakes.back,onfocus:beginEdit,oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.back=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.back); endEdit(); }}) ]),
              h('div',{},[ h('div',{class:'muted'},'Overall $'), h('input',{type:'tel',inputmode:'numeric',pattern:'[0-9]*',value:g.stakes.overall,onfocus:beginEdit,oninput:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); if(d!==e.target.value) e.target.value=d; },onblur:function(e){ var d=e.target.value.replace(/[^0-9]/g,''); g.stakes.overall=parseInt(d||'0',10)||0; e.target.value=String(g.stakes.overall); endEdit(); }}) ])
            ]),
            h('div',{class:'grid grid-3'},[
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.front,onclick:function(e){ g.autoPress.front=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ]),
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.back,onclick:function(e){ g.autoPress.back=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ]),
              h('label',{},[ h('input',{type:'checkbox',checked:g.autoPress.overall,onclick:function(e){ g.autoPress.overall=!!e.target.checked; queueSave(); render(); }}),' Auto-Press 2DN' ])
            ]),
            strokesEditor(g),
            h('div',{class:'note'},'Scores tab shows GROSS only. Net is auto from strokes + course HCP.')
          ])
        ]);
        gamesCardChildren.push(card);
      })(state.games[gi],gi);
    }

    return h('div',{},[ playersCard, courseCard(), h('div',{},gamesCardChildren) ]);
  }

  function screenScores(){
  var g0 = state.games[0];
  var lastHole = -1;

  // find rightmost hole that has any value to auto-scroll there
  try{
    for(var holeI=0; holeI<18; holeI++){
      for(var pi=0; pi<state.players.length; pi++){
        var pid = state.players[pi].id;
        var v   = g0 && g0.gross && g0.gross[pid] ? g0.gross[pid][holeI] : null;
        if(v != null && v !== '') lastHole = holeI;
      }
    }
  }catch(_e){}

  function updateSums(pid){
    var arr = g0.gross[pid];
    var f   = sumGrossRange(arr,0,8);
    var b   = sumGrossRange(arr,9,17);
    var tot = (f==null && b==null)? null : ((f||0)+(b||0));
    var fEl = document.getElementById('sumF_'+pid),
        bEl = document.getElementById('sumB_'+pid),
        tEl = document.getElementById('sumT_'+pid);
    if(fEl) fEl.textContent = (f==null?'':String(f));
    if(bEl) bEl.textContent = (b==null?'':String(b));
    if(tEl) tEl.textContent = (tot==null?'':String(tot));
  }

  // keyboard navigation (desktop + iPhone numpad arrows)
  function moveFocusRelative(e, dir){ // dir: +1 down, -1 up (wrap)
    var td    = e.target.closest("td");
    var tr    = e.target.closest("tr");
    var tbody = tr && tr.parentElement;
    if(!td || !tr || !tbody) return;

    var rows     = Array.from(tbody.children);
    var rowIndex = rows.indexOf(tr);
    var cellIndex= Array.prototype.indexOf.call(tr.children, td);

    var nextIndex = (rowIndex + dir + rows.length) % rows.length;
    var nextRow   = rows[nextIndex];
    var nextCell  = nextRow && nextRow.children[cellIndex];
    if(nextCell){
      var nextInput = nextCell.querySelector("input");
      if(nextInput){ nextInput.focus(); }
    }
  }

  function grossInput(pid,hole){
    return h('input',{
      type:'tel', inputmode:'numeric', pattern:'[0-9]*', placeholder:'-',
      value:(g0.gross[pid][hole]==null?'':String(g0.gross[pid][hole])),
      onfocus: beginEdit,
      oninput: function(e){
        var d = e.target.value.replace(/[^0-9]/g,'');
        if(d !== e.target.value) e.target.value = d;
        var v = (d==='')? null : parseInt(d,10);
        for(var gi=0; gi<state.games.length; gi++){
          state.games[gi].gross[pid][hole] = (isNaN(v)? null : v);
        }
      },
      onblur: function(e){
        var d = e.target.value.replace(/[^0-9]/g,'');
        var v = (d==='')? null : parseInt(d,10);
        for(var gi=0; gi<state.games.length; gi++){
          state.games[gi].gross[pid][hole] = (isNaN(v)? null : v);
        }
        e.target.value = (v==null?'':String(v));
        updateSums(pid);
        endEdit();
      },
      onkeydown: function(e){
        if(e.key === "Enter" || e.key === "ArrowDown" || e.key === "ArrowUp"){
          e.preventDefault();
          moveFocusRelative(e, (e.key === "ArrowUp") ? -1 : +1);
        }
      }
    });
  }

  var head = [h('th',{class:'sticky'},'Player')];
  for(var hi=0; hi<18; hi++) head.push(h('th',{id:'col_h_'+hi},String(hi+1)));
  head.push(h('th',{},'F'), h('th',{},'B'), h('th',{},'TOT'));

  var rows = [];
  for(var i=0; i<state.players.length; i++){
    (function(p){
      var cells=[h('td',{class:'sticky'},p.name)];
      for(var hh=0; hh<18; hh++){
        cells.push(
          h('td',{},[
            h('div',{class:'cellWrap'},[
              grossInput(p.id,hh),
              strokeDots(p.id,hh) || ''
            ])
          ])
        );
      }
      var arr=g0.gross[p.id],
          f=sumGrossRange(arr,0,8),
          b=sumGrossRange(arr,9,17),
          tot=(f==null && b==null)? null : ((f||0)+(b||0));
      cells.push(h('td',{id:'sumF_'+p.id},(f==null?'':String(f))));
      cells.push(h('td',{id:'sumB_'+p.id},(b==null?'':String(b))));
      cells.push(h('td',{id:'sumT_'+p.id},(tot==null?'':String(tot))));
      rows.push(h('tr',{},cells));
    })(state.players[i]);
  }

  var thead = h('thead',{},[h('tr',{},head)]);
  var tbody = h('tbody',{},rows);
  var scroller = h('div',{class:'card scroll', id:'scoresScroll'},[
    h('table',{},[thead,tbody])
  ]);

  var root = h('div',{},[
    h('div',{class:'row',style:'align-items:center;'},[
      h('div',{class:'pill'},'Entering GROSS for all players'),
      h('div',{class:'note'},'Use Enter / ↓ / ↑ to move; sums update on blur.')
    ]),
    scroller
  ]);

  setTimeout(function(){
    try{
      if(lastHole>=0){
        var col = document.getElementById('col_h_'+lastHole),
            sc  = document.getElementById('scoresScroll');
        if(col && sc){
          var target = Math.max(0, col.offsetLeft - sc.clientWidth*0.2);
          sc.scrollLeft = target;
        }
      }
    }catch(_e){}
  },0);

  return root;
}

  function screenStatus(){
  // --- helpers ---
  function diffsArray(g){ var a=[]; for(var i=0;i<18;i++) a.push(holeDiff(g,i)); return a; }
  function curLine(diffs,line){ var sum=0,saw=false; for(var h=line.start; h<=line.end; h++){ var d=diffs[h]; if(d==null) break; saw=true; sum+=d; } return saw?sum:null; }

  // Sum junk *points* (no $) for a team over a hole range
  function junkPointsForRange(g, teamPids, start, end){
    var t=0;
    for(var i=0;i<teamPids.length;i++){
      var pid=teamPids[i], arr=(g.junkCounts[pid]||[]);
      for(var h=start; h<=end; h++) t += (+arr[h]||0);
    }
    return t;
  }

  // segment row builder: shows Bets summary and Junk A/B counts
 function seg(g,label,start,end,autoKey){
  var sg = buildSegmentLines(g,start,end,0,!!g.autoPress[autoKey]);
  var diffs = diffsArray(g);

  // Build "Bets" text like "+4/+2/E"
  var parts=[], any=false;
  for(var i=0;i<sg.lines.length;i++){
    var L=sg.lines[i];
    var c=curLine(diffs,L);
    if(c===null){ parts.push('—'); }
    else { any=true; parts.push(c>0?('+'+c):(c<0?String(c):'E')); }
  }
  var betsText = any? parts.join(' / ') : '—';

  // Junk point totals
  var aPts = junkPointsForRange(g, g.teamA||[], start, end);
  var bPts = junkPointsForRange(g, g.teamB||[], start, end);

  return h('div',{class:'card'},[
    h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
      h('div',{class:'muted'},label),
      h('div',{class:'pill'},[
        h('div',{},'Bets: '+betsText),
        h('div',{},'Junk: A='+aPts+' B='+bPts)
      ])
    ])
  ]);
}

  var blocks=[ h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
    h('label',{},[
      h('input',{type:'checkbox',checked:!!state.debugStatus,onclick:function(e){ state.debugStatus=!!e.target.checked; queueSave(); render(); }}),
      ' Show debug details'
    ])
  ]) ];

  for(var gi=0; gi<state.games.length; gi++){
    (function(g,idx){
      var theme=idx===0?'theme-g1':(idx===1?'theme-g2':(idx===2?'theme-g3':''));
      blocks.push(h('div',{class:theme},[
        h('div',{class:'card'},[
          h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
            h('div',{class:'pill'},gameShortLabel(g)),
            h('div',{class:'note'},'Positive = Team A')
          ]),
          h('div',{class:'note'}, 'A: '+(g.teamA||[]).map(playerName).join(' & ')+'  |  B: '+(g.teamB||[]).map(playerName).join(' & ')),

          // Segment rows with Bets + Junk (points)
          seg(g,'Front (1–9)',    0, 8, 'front'),
          seg(g,'Back (10–18)',   9,17, 'back'),
          seg(g,'Overall (1–18)', 0,17, 'overall')
        ])
      ]));
    })(state.games[gi],gi);
  }
  return h('div',{},blocks);
}

 function screenJunk(){
  var blocks = [];

  // helper: sum [start..end] inclusive for a player's junk array
  function sumJunkRange(arr, start, end){
    var t = 0, any = false;
    for(var i = start; i <= end; i++){
      var v = arr && arr[i];
      if(v != null && isFinite(+v)){
        t += +v;
        any = true;
      }
    }
    return any ? t : null;
  }

  for (var gi = 0; gi < state.games.length; gi++){
    (function(g, idx){
      var pids  = [].concat(g.teamA || [], g.teamB || []);
      var theme = idx===0 ? 'theme-g1' : (idx===1 ? 'theme-g2' : (idx===2 ? 'theme-g3' : ''));
      var tableIdPrefix = 'junk_' + (g.id || ('g' + idx));
      var scrollId = tableIdPrefix + '_scroll';

      function moveFocusRelative(e, dir){ // dir: +1 down, -1 up (wrap)
        var td = e.target.closest("td");
        var tr = e.target.closest("tr");
        var tbody = tr && tr.parentElement;
        if(!td || !tr || !tbody) return;

        var rows = Array.from(tbody.children);
        var rowIndex = rows.indexOf(tr);
        var cellIndex = Array.prototype.indexOf.call(tr.children, td);

        var nextIndex = (rowIndex + dir + rows.length) % rows.length;
        var nextRow = rows[nextIndex];
        var nextCell = nextRow && nextRow.children[cellIndex];
        if(nextCell){
          var nextInput = nextCell.querySelector("input");
          if(nextInput){ nextInput.focus(); }
        }
      }

      function junkInput(pid, hole, gRef){
        if(!gRef.junkCounts[pid]) gRef.junkCounts[pid] = make18(0);
        var cur = gRef.junkCounts[pid][hole];
        if(!Number.isFinite(cur)) { cur = 0; gRef.junkCounts[pid][hole] = 0; }

        var displayVal   = (cur === 0 ? '' : String(cur));
        var displayBadge = (cur === 0 ? '' : String(cur));
        var badge = h('span', { class:'junkVal' }, displayBadge);

        return h('div', { class:'junkWrap' }, [
          h('input',{
            class:'junkBox',
            type:'text',
            inputmode:'numeric',
            pattern:'[0-9]*',
            autocomplete:'off',
            placeholder:'-',
            value: displayVal,
            oninput: function(e){
              var digits = e.target.value.replace(/[^0-9]/g,'');
              if(digits !== e.target.value) e.target.value = digits;
              var v = (digits === '') ? 0 : parseInt(digits,10);
              gRef.junkCounts[pid][hole] = v;
              badge.textContent = (v === 0 ? '' : String(v));
              try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){}
            },
            onblur: function(e){
              var digits = e.target.value.replace(/[^0-9]/g,'');
              var v = (digits === '') ? 0 : parseInt(digits,10);
              gRef.junkCounts[pid][hole] = v;
              e.target.value = (v === 0 ? '' : String(v));
              badge.textContent = (v === 0 ? '' : String(v));
              try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneForSave())); }catch(_e){}
            },
            onkeydown: function(e){
              if(e.key === "Enter" || e.key === "ArrowDown" || e.key === "ArrowUp"){
                e.preventDefault();
                moveFocusRelative(e, (e.key === "ArrowUp") ? -1 : +1);
              }
            }
          }),
          badge
        ]);
      }

      // find the rightmost hole index that has any junk > 0 for this game
      var lastHole = -1;
      try{
        for(var holeI=0; holeI<18; holeI++){
          for(var pi=0; pi<pids.length; pi++){
            var pid = pids[pi];
            var v = g && g.junkCounts && g.junkCounts[pid] ? g.junkCounts[pid][holeI] : 0;
            if(v && +v !== 0){ lastHole = holeI; }
          }
        }
      }catch(_e){}

      // Header row (Player + 1..18 + F + B)
      var head = [ h('th', { class:'sticky' }, 'Player') ];
      for (var j=0; j<18; j++){
        head.push(h('th', { id: tableIdPrefix + '_h_' + j }, String(j+1)));
      }
      head.push(h('th', {}, 'F'), h('th', {}, 'B'));

      // Body rows with per-player F/B totals
      var rows = [];
      for (var i=0; i<pids.length; i++){
        (function(pid){
          var cells=[ h('td', { class:'sticky' }, playerName(pid)) ];
          for (var hIdx=0; hIdx<18; hIdx++){
            cells.push( h('td', {}, [ junkInput(pid, hIdx, g) ]) );
          }
          // totals
          var f = sumJunkRange(g.junkCounts[pid], 0, 8);
          var b = sumJunkRange(g.junkCounts[pid], 9, 17);
          cells.push( h('td', { style:'vertical-align:middle;' }, f==null ? '' : String(f)) );
          cells.push( h('td', { style:'vertical-align:middle;' }, b==null ? '' : String(b)) );
          rows.push( h('tr', {}, cells) );
        })(pids[i]);
      }

      var thead  = h('thead', {}, [ h('tr', {}, head) ]);
      var tbody  = h('tbody', {}, rows);
      var grid   = h('div', { class:'card scroll', id: scrollId }, [ h('table', {}, [ thead, tbody ]) ]);

      // Per-game junk pricing editors
      var pricing = h('div', { class:'card' }, [
  h('div', { class:'junkValueBar' }, [
    h('div', { class:'pill' }, 'Junk $/point:'),
    h('div', { class:'muted' }, 'Front'),
    h('input', {
      type:'tel', inputmode:'numeric', pattern:'[0-9]*',
      value: g.junkValue.front,
      onfocus: beginEdit,
      oninput: function(e){
        var d=e.target.value.replace(/[^0-9]/g,'');
        if(d!==e.target.value) e.target.value=d;
      },
      onblur: function(e){
        var d=e.target.value.replace(/[^0-9]/g,'');
        g.junkValue.front = parseInt(d||'0',10)||0;
        e.target.value = String(g.junkValue.front);
        endEdit();
      }
    }),
    h('div', { class:'muted' }, 'Back'),
    h('input', {
      type:'tel', inputmode:'numeric', pattern:'[0-9]*',
      value: g.junkValue.back,
      onfocus: beginEdit,
      oninput: function(e){
        var d=e.target.value.replace(/[^0-9]/g,'');
        if(d!==e.target.value) e.target.value=d;
      },
      onblur: function(e){
        var d=e.target.value.replace(/[^0-9]/g,'');
        g.junkValue.back = parseInt(d||'0',10)||0;
        e.target.value = String(g.junkValue.back);
        endEdit();
      }
    })
  ])
]);


      // Card header
      var namesA=(g.teamA||[]).map(playerName).join(' & ');
      var namesB=(g.teamB||[]).map(playerName).join(' & ');

      blocks.push(
        h('div', { class: theme }, [
          h('div', { class:'card' }, [
            h('div', { class:'row', style:'align-items:center; justify-content:space-between;' }, [
              h('div', { class:'pill' }, gameShortLabel(g)),
              h('div', { class:'note' }, 'A: '+(namesA||'—')+'  |  B: '+(namesB||'—'))
            ])
          ]),
          pricing,
          grid,
          h('div', { class:'note' }, 'Per-hole junk counts × Front/Back $ are included and doubled at team settlement.')
        ])
      );

      // Auto-scroll this game's grid to last hole if any
      setTimeout(function(){
        try{
          if(lastHole >= 0){
            var col = document.getElementById(tableIdPrefix + '_h_' + lastHole);
            var sc  = document.getElementById(scrollId);
            if(col && sc){
              var target = Math.max(0, col.offsetLeft - sc.clientWidth * 0.2);
              sc.scrollLeft = target;
            }
          }
        }catch(_e){}
      }, 0);

    })(state.games[gi], gi);
  }

  return h('div', {}, blocks);
}
 function screenGame(){
  var blocks=[];

  for(var gi=0; gi<state.games.length; gi++){
    (function(g, idx){
      var res = computeGameResult(g);
      var theme = idx===0 ? 'theme-g1' : (idx===1 ? 'theme-g2' : (idx===2 ? 'theme-g3' : ''));

      function seg(label, segRes){
        var pills=[];
        for(var i=0;i<segRes.lines.length;i++){
          var L=segRes.lines[i];
          pills.push(
            h('div',{class:'pill'}, (L.pressedBy?'Press':'Main')+' • '+(L.start+1)+'–'+(L.end+1)+' • '+segRes.winnerByLine[i] )
          );
        }
        var teamTotalDbl = segRes.payoutA * 2; // (existing logic) team-level, doubled
        return h('div',{class:'card'},[
          h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
            h('div',{},label),
            h('div',{class:'muted'},'Net to Team A (Team/Player): '+fmtTeamPlayer(teamTotalDbl))
          ]),
          h('div',{class:'row'},pills)
        ]);
      }

      var aN=(g.teamA||[]).map(playerName).join(' & ');
      var bN=(g.teamB||[]).map(playerName).join(' & ');

      blocks.push(
        h('div',{class:theme},[
          h('div',{class:'card'},[
            h('div',{class:'row',style:'align-items:center; justify-content:space-between;'},[
              h('div',{class:'pill'}, gameShortLabel(g)),
              h('div',{class:'note'}, 'Positive = Team A')
            ]),
            h('div',{class:'note'}, 'A: '+(aN||'—')+'  |  B: '+(bN||'—')),

            // Segments
            seg('Front (1–9)',    res.segments.front),
            seg('Back (10–18)',   res.segments.back),
            seg('Overall (1–18)', res.segments.overall),

            // Junk & Game Total (Team/Player display only)
            h('div',{class:'card'},[
              h('div',{class:'pill'}, 'Junk to Team A (Team/Player): '+fmtTeamPlayer(res.teamTotals.junk))
            ]),
            h('div',{class:'card'},[
              h('div',{class:'pill'}, 'Game Total to Team A (Team/Player): '+fmtTeamPlayer(res.teamTotals.total))
            ])
          ])
        ])
      );
    })(state.games[gi], gi);
  }

  return h('div',{},blocks);
}



  function screenTransactions(){
    // Per-player net across all games (doubled team totals already included in computeGameResult)
    var net={}; for(var pi=0; pi<state.players.length; pi++) net[state.players[pi].id]=0;
    var perGameRows=[];
    for(var gi=0; gi<state.games.length; gi++){
      var gm=state.games[gi], r=computeGameResult(gm), total=r.teamTotals.total; // already doubled at team level
      var aShare=total/2, bShare=-total/2; // split equally within team
      for(var t=0;t<(gm.teamA||[]).length;t++){ var idA=gm.teamA[t]; if(idA) net[idA]+=aShare; }
      for(var u=0;u<(gm.teamB||[]).length;u++){ var idB=gm.teamB[u]; if(idB) net[idB]+=bShare; }
      perGameRows.push(h('li',{}, gameShortLabel(gm)+': '+fmt(total)+' to Team A'));
    }
    var xfers=settleMinimalCash(net);
    var perList=(function(){ var arr=[]; for(var i=0;i<state.players.length;i++){ var p=state.players[i]; arr.push(h('li',{}, p.name+': '+fmt(net[p.id]))); } return arr; })();
    var xfList=(function(){ var arr=[]; for(var i=0;i<xfers.length;i++){ var t=xfers[i]; arr.push(h('li',{}, playerName(t.from)+' → '+playerName(t.to)+': '+fmt(t.amount))); } return arr; })();

    // One tinted card per game list for theme consistency
    var themed=[];
    for(var gi2=0; gi2<state.games.length; gi2++){
      (function(g,idx){ var theme=idx===0?'theme-g1':(idx===1?'theme-g2':(idx===2?'theme-g3':'')); themed.push(h('div',{class:theme},[h('div',{class:'card'},[h('div',{class:'pill'}, gameShortLabel(g))]) ])); })(state.games[gi2],gi2);
    }

    return h('div',{},[
      h('div',{class:'card'},[ h('div',{class:'pill'},'Per-Game Totals (to Team A)'), (perGameRows.length? h('ul',{},perGameRows) : h('div',{class:'muted'},'No games yet.')) ]),
      h('div',{class:'card'},[ h('div',{class:'pill'},'Per-Player Net (All Games + Junk)') , h('ul',{},perList) ]),
      h('div',{class:'card'},[ h('div',{class:'pill'},'Least-Cash Transfers'), (xfers.length? h('ul',{},xfList) : h('div',{class:'muted'},'All square.')) ]),
      h('div',{},themed)
    ]);
  }

  // ===== Presets =====
  function applyPresetByName(name){
    var arr=COURSE_PRESETS[name];
    if(!Array.isArray(arr) || arr.length!==18){ alert('Preset must have exactly 18 numbers.'); return; }
    var seen={}; for(var i=0;i<18;i++){ var n=+arr[i]; if(!(n>=1&&n<=18)) { alert('All handicap numbers must be 1–18.'); return; } if(seen[n]){ alert('Each number 1–18 must appear exactly once.'); return; } seen[n]=true; }
    state.course.hcp=arr.slice(); state.course.name=name; queueSave(); render();
  }

  // ===== Render =====
  function render(){
    if(__locks>0) return;
    try{
      // tabs
      Tabs();

      // choose view
      var root=document.getElementById('app'); root.innerHTML='';
      var view;
      if(state.tab==='setup') view=screenSetup();
      else if(state.tab==='scores') view=wrapThemes(screenScores());
      else if(state.tab==='junk') view=wrapThemes(screenJunk());
      else if(state.tab==='status') view=wrapThemes(screenStatus());
      else if(state.tab==='game') view=wrapThemes(screenGame());
      else if(state.tab==='transactions') view=wrapThemes(screenTransactions());
      else view=wrapThemes(screenGame());

      root.appendChild(view);
      errBox.style.display='none';
    }catch(e){
      errBox.style.display='block'; errBox.textContent='Render failed: '+(e && e.message ? e.message : String(e));
      console.error(e);
    }
  }

  // Wrap a view so each game section can have its tint (non-setup screens)
  function wrapThemes(viewNode){
    var wrap=h('div',{},[]);
    // just return the node if it already has theme blocks inside
    wrap.appendChild(viewNode);
    return wrap;
  }

  // Buttons
  document.getElementById('resetBtn').addEventListener('click', function(){
    if(!confirm('Start a brand-new round? This clears all scores/junk and resets teams/stakes to defaults.')) return;
    try{ localStorage.removeItem(STORAGE_KEY); }catch(_e){}
    state.players=[{id:'p1',name:'P1'},{id:'p2',name:'P2'},{id:'p3',name:'P3'},{id:'p4',name:'P4'},{id:'p5',name:'P5'}];
    state.games=[];
    var ng=makeNewGame(false);
    state.games=[ng];
    state.activeGameId=ng.id;
    state.course={name:'El Macero Temp', hcp:[3,11,17,7,13,1,15,9,5,4,12,18,8,14,2,16,10,6]};
    saveState(); render();
  });
  document.getElementById('clearBtn').addEventListener('click', function(){
    if(!confirm('Clear saved data and wipe current scores/junk in this session?')) return;
    try{ localStorage.removeItem(STORAGE_KEY); }catch(_e){}
    for(var gi=0; gi<state.games.length; gi++){
      var g=state.games[gi];
      for(var pi=0; pi<state.players.length; pi++){
        var pid=state.players[pi].id;
        g.gross[pid]=make18(null);
        g.junkCounts[pid]=make18(0);
      }
    }
    saveState(); render(); alert('Saved data cleared and round scores wiped.');
  });

  render();
})();
</script>
</body>
</html>
